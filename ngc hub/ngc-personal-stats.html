<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGC Personal Stats - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d4a2b 50%, #1a1a1a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 10px,
          rgba(45, 74, 43, 0.03) 10px,
          rgba(45, 74, 43, 0.03) 20px
        );
      pointer-events: none;
      z-index: 1;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(30, 40, 30, 0.95);
      border: 3px solid #4a6b47;
      box-shadow: 0 0 30px rgba(74, 107, 71, 0.5);
      position: relative;
      z-index: 2;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, 
        #4a6b47 0%, 
        #7fa87a 25%, 
        #4a6b47 50%, 
        #7fa87a 75%, 
        #4a6b47 100%
      );
    }

    .header {
      background: linear-gradient(135deg, #2d4a2b 0%, #1a2e1a 100%);
      color: #a8d5a3;
      padding: 30px;
      text-align: center;
      border-bottom: 3px solid #4a6b47;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        #7fa87a 50%, 
        transparent 100%
      );
    }

    .language-selector {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .lang-btn {
      background: rgba(74, 107, 71, 0.3);
      border: 2px solid #4a6b47;
      color: #a8d5a3;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      background: rgba(74, 107, 71, 0.5);
      border-color: #90EE90;
      color: #90EE90;
      transform: scale(1.05);
    }

    .lang-btn.active {
      background: #4a6b47;
      border-color: #90EE90;
      color: #90EE90;
      box-shadow: 0 0 10px rgba(144, 238, 144, 0.3);
    }

    .ngc-logo {
      font-size: 2.5em;
      font-weight: bold;
      color: #7fa87a;
      text-shadow: 0 0 10px rgba(127, 168, 122, 0.8);
      margin-bottom: 5px;
      letter-spacing: 8px;
    }

    .header h1 {
      font-size: 1.5em;
      color: #c4e3bf;
      letter-spacing: 3px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.95em;
      color: #a8d5a3;
    }

    .tactical-line {
      height: 1px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        #4a6b47 10%, 
        #7fa87a 50%, 
        #4a6b47 90%, 
        transparent 100%
      );
      margin: 15px 0;
    }

    .content { padding: 30px; }

    /* AUTH SECTIONS */
    .auth-section {
      background: linear-gradient(135deg, #2d4a2b 0%, #3d5a3b 100%);
      border: 2px solid #4a6b47;
      padding: 40px;
      margin-bottom: 30px;
      color: #c4e3bf;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .section-title {
      text-align: center;
      font-size: 1.3em;
      color: #7fa87a;
      margin-bottom: 30px;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 5px rgba(127, 168, 122, 0.5);
    }

    .input-group {
      margin-bottom: 25px;
    }

    .input-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.1em;
      color: #a8d5a3;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #4a6b47;
      background: rgba(0, 0, 0, 0.4);
      color: #c4e3bf;
      font-size: 1.1em;
      font-family: 'Courier New', monospace;
    }

    .input-group input:focus {
      outline: none;
      border-color: #7fa87a;
      box-shadow: 0 0 10px rgba(127, 168, 122, 0.3);
    }

    .btn {
      padding: 15px 30px;
      border: 2px solid #4a6b47;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #4a6b47 0%, #5a7b57 100%);
      color: #c4e3bf;
      transition: all 0.3s;
      margin: 10px 0;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .btn:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a7b57 0%, #6a8b67 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 107, 71, 0.5);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3d5a3b 0%, #4d6a4b 100%);
    }

    .alert {
      padding: 15px;
      margin: 15px 0;
      display: none;
      border: 2px solid;
      font-weight: bold;
    }

    .alert-error {
      background: rgba(107, 71, 71, 0.3);
      color: #d5a3a3;
      border-color: #a87a7a;
    }

    .alert-success {
      background: rgba(74, 107, 71, 0.3);
      color: #a8d5a3;
      border-color: #7fa87a;
    }

    .alert-info {
      background: rgba(74, 107, 107, 0.3);
      color: #a3d5d5;
      border-color: #7aa8a8;
    }

    .pin-display {
      background: rgba(127, 168, 122, 0.2);
      border: 3px solid #7fa87a;
      padding: 30px;
      margin: 20px 0;
      text-align: center;
    }

    .pin-code {
      font-size: 3em;
      color: #90EE90;
      font-weight: bold;
      letter-spacing: 8px;
      margin: 20px 0;
      text-shadow: 0 0 10px rgba(144, 238, 144, 0.5);
    }

    .pin-warning {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
      color: #ffe082;
    }

    /* DASHBOARD */
    .dashboard { 
      display: none;
    }

    .welcome {
      background: linear-gradient(135deg, #4a6b47 0%, #5a7b57 100%);
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
      border: 2px solid #7fa87a;
    }

    .welcome h2 {
      color: #c4e3bf;
      font-size: 1.8em;
      letter-spacing: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(45, 74, 43, 0.5);
      border: 2px solid #4a6b47;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #4a6b47 0%, #7fa87a 50%, #4a6b47 100%);
    }

    .stat-title {
      font-size: 0.9em;
      color: #a8d5a3;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2em;
      color: #7fa87a;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 1.1em;
      font-weight: bold;
    }

    .stat-change.positive { color: #90EE90; }
    .stat-change.negative { color: #ff6b6b; }
    .stat-change.neutral { color: #a8d5a3; }

    .chart-section {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #4a6b47;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 1.1em;
      color: #7fa87a;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      text-align: center;
    }

    .ranking-card {
      background: linear-gradient(135deg, #2d4a2b 0%, #1a2e1a 100%);
      border: 2px solid #4a6b47;
      padding: 25px;
      margin-bottom: 30px;
    }

    .ranking-position {
      text-align: center;
      font-size: 3em;
      color: #7fa87a;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 0 0 10px rgba(127, 168, 122, 0.5);
    }

    .ranking-info {
      color: #c4e3bf;
      font-size: 1.1em;
      line-height: 1.8;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .history-table th {
      background: #2d4a2b;
      color: #a8d5a3;
      padding: 12px;
      text-align: center;
      border: 1px solid #4a6b47;
      font-size: 0.9em;
    }

    .history-table td {
      background: rgba(0, 0, 0, 0.3);
      color: #c4e3bf;
      padding: 10px;
      text-align: center;
      border: 1px solid #4a6b47;
    }

    .history-table tr:nth-child(even) td {
      background: rgba(45, 74, 43, 0.2);
    }

    .logout-btn {
      margin-top: 30px;
      background: linear-gradient(135deg, #6b4747 0%, #7b5757 100%);
    }

    .logout-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #7b5757 0%, #8b6767 100%);
    }

    @media (max-width: 768px) {
      .ngc-logo { font-size: 2em; letter-spacing: 4px; }
      .header h1 { font-size: 1.2em; }
      .content { padding: 15px; }
      .auth-section { padding: 20px; }
      .stats-grid { grid-template-columns: 1fr; }
      .pin-code { font-size: 2em; letter-spacing: 4px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="language-selector">
        <button class="lang-btn active" data-lang="it">üáÆüáπ IT</button>
        <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑ FR</button>
      </div>
      <div class="ngc-logo">NGC</div>
      <h1>PERSONAL STATS DASHBOARD</h1>
      <div class="tactical-line"></div>
      <p>üìä Track Your Growth & Progress</p>
    </div>

    <div class="content">
      <!-- CHOICE SECTION -->
      <div id="choiceSection" class="auth-section">
        <div class="section-title">üîê Accesso</div>
        
        <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em;">
          Prima volta o hai gi√† un PIN?
        </p>

        <button class="btn" id="firstTimeBtn">üÜï Prima Volta - Genera PIN</button>
        <button class="btn btn-secondary" id="havePINBtn">üîë Ho gi√† un PIN - Accedi</button>
      </div>

      <!-- REGISTER SECTION -->
      <div id="registerSection" class="auth-section" style="display: none;">
        <div class="section-title">üÜï Genera il Tuo PIN</div>
        
        <div class="alert alert-info" style="display: block;">
          ‚ÑπÔ∏è Inserisci il tuo nome e il codice segreto dell'alleanza per generare il tuo PIN personale.
        </div>

        <div class="input-group">
          <label for="regPlayerName">üë§ Nome Giocatore:</label>
          <input type="text" id="regPlayerName" placeholder="Il tuo nome in-game" />
        </div>

        <div class="input-group">
          <label for="regSecretCode">üîë Codice Segreto Alleanza:</label>
          <input type="password" id="regSecretCode" placeholder="Codice alleanza" />
        </div>

        <button class="btn" id="generatePINBtn">üé≤ Genera il Mio PIN</button>
        <button class="btn btn-secondary" id="backToChoiceBtn">‚¨ÖÔ∏è Indietro</button>
        
        <div class="alert alert-error" id="regErrorAlert"></div>
      </div>

      <!-- PIN DISPLAY SECTION -->
      <div id="pinDisplaySection" class="auth-section" style="display: none;">
        <div class="section-title">üéâ PIN Generato con Successo!</div>
        
        <div class="pin-display">
          <p style="font-size: 1.2em; margin-bottom: 15px;">Il tuo PIN personale √®:</p>
          <div class="pin-code" id="generatedPIN">------</div>
          <p style="font-size: 0.95em; color: #a8d5a3;">Giocatore: <strong id="generatedPlayerName"></strong></p>
        </div>

        <div class="pin-warning">
          ‚ö†Ô∏è <strong>IMPORTANTE:</strong><br>
          ‚Ä¢ Salva questo PIN in un posto sicuro!<br>
          ‚Ä¢ Lo userai per accedere alle tue statistiche<br>
          ‚Ä¢ Se lo perdi, contatta il proprietario del database
        </div>

        <button class="btn" id="gotoPINLoginBtn">‚úÖ Ho Salvato il PIN - Continua</button>
      </div>

      <!-- LOGIN SECTION -->
      <div id="loginSection" class="auth-section" style="display: none;">
        <div class="section-title">üîë Accedi con PIN</div>
        
        <div class="input-group">
          <label for="loginPlayerName">üë§ Nome Giocatore:</label>
          <input type="text" id="loginPlayerName" placeholder="Il tuo nome in-game" />
        </div>

        <div class="input-group">
          <label for="loginPIN">üîê PIN Personale:</label>
          <input type="text" id="loginPIN" placeholder="Il tuo PIN (6 caratteri)" maxlength="6" style="text-transform: uppercase;" />
        </div>

        <button class="btn" id="loginBtn">üìä Visualizza Statistiche</button>
        <button class="btn btn-secondary" id="backToChoice2Btn">‚¨ÖÔ∏è Indietro</button>
        
        <div class="alert alert-error" id="loginErrorAlert"></div>
        
        <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #a8d5a3;">
          PIN perso? Contatta il proprietario del database
        </p>
      </div>

      <!-- DASHBOARD SECTION -->
      <div id="dashboardSection" class="dashboard">
        <div class="welcome">
          <h2>üëã Benvenuto, <span id="welcomeName"></span>!</h2>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-title">üöÄ Missili</div>
            <div class="stat-value" id="statMissile">-</div>
            <div class="stat-change" id="changeMissile">-</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-title">‚úàÔ∏è Aerei</div>
            <div class="stat-value" id="statAerei">-</div>
            <div class="stat-change" id="changeAerei">-</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-title">üöú Tank</div>
            <div class="stat-value" id="statTank">-</div>
            <div class="stat-change" id="changeTank">-</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-title">üí™ Totale</div>
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-change" id="changeTotal">-</div>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-title">üìà Trend Crescita (Ultimi 10 Aggiornamenti)</div>
          <div style="position: relative; height: 250px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <div id="rankingSection" class="ranking-card">
          <div class="chart-title">üèÜ Posizione in Alleanza</div>
          <div class="ranking-position" id="rankPosition">-</div>
          <div class="ranking-info" id="rankInfo"></div>
        </div>

        <div class="chart-section">
          <div class="chart-title">üìÖ Storico Aggiornamenti</div>
          <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            <div id="historyContainer"></div>
          </div>
        </div>

        <button class="btn logout-btn" id="logoutBtn">üö™ Esci</button>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ AGGIORNATO CON IL TUO NUOVO DEPLOY URL!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUh8QZSS776kD393oDBjSWbAksvV8Yop59T9JiwM44/dev';
    
    let chartInstance = null;
    let currentLang = 'it';
    let allianceConfig = null;

    // TRANSLATIONS
    const translations = {
      it: {
        title: "NGC - Statistiche Personali",
        firstTime: "üÜï Prima volta? Genera PIN",
        alreadyHave: "‚úÖ Ho gi√† un PIN",
        registerTitle: "üìù Registrazione Nuovo Giocatore",
        playerName: "Nome Giocatore",
        secretCode: "Codice Segreto Alleanza",
        generatePIN: "üîê Genera PIN",
        back: "‚Üê Indietro",
        pinGenerated: "‚úÖ PIN Generato con Successo!",
        gotoLogin: "üöÄ Vai al Login",
        loginTitle: "üîê Login con PIN",
        enterPIN: "Inserisci PIN",
        login: "üöÄ Accedi",
        welcome: "üëã Benvenuto,",
        missiles: "üöÄ Missili",
        aircraft: "‚úàÔ∏è Aerei",
        tanks: "üöú Tank",
        total: "üí™ Totale",
        trendGrowth: "üìà Trend Crescita (Ultimi 10 Aggiornamenti)",
        alliancePosition: "üèÜ Posizione in Alleanza",
        position: "Posizione:",
        outOf: "su",
        players: "giocatori",
        yourTotal: "üí™ Tuo totale:",
        allianceLeader: "ü•á Leader alleanza:",
        distanceFrom1: "üìä Distacco da #1:",
        allianceAvg: "üìà Media alleanza:",
        history: "üìÖ Storico Aggiornamenti",
        date: "Data",
        logout: "üö™ Esci",
        errorPlayerName: "Inserisci il tuo nome giocatore",
        errorSecretCode: "Inserisci il codice segreto alleanza",
        errorPIN: "Inserisci il tuo PIN",
        errorInvalidCredentials: "Credenziali non valide",
        generatingPIN: "‚è≥ Generazione PIN...",
        loggingIn: "‚è≥ Accesso in corso...",
        noChange: "‚û°Ô∏è Nessuna variazione"
      },
      en: {
        title: "NGC - Personal Stats",
        firstTime: "üÜï First time? Generate PIN",
        alreadyHave: "‚úÖ I already have a PIN",
        registerTitle: "üìù New Player Registration",
        playerName: "Player Name",
        secretCode: "Alliance Secret Code",
        generatePIN: "üîê Generate PIN",
        back: "‚Üê Back",
        pinGenerated: "‚úÖ PIN Generated Successfully!",
        gotoLogin: "üöÄ Go to Login",
        loginTitle: "üîê Login with PIN",
        enterPIN: "Enter PIN",
        login: "üöÄ Login",
        welcome: "üëã Welcome,",
        missiles: "üöÄ Missiles",
        aircraft: "‚úàÔ∏è Aircraft",
        tanks: "üöú Tanks",
        total: "üí™ Total",
        trendGrowth: "üìà Growth Trend (Last 10 Updates)",
        alliancePosition: "üèÜ Alliance Position",
        position: "Position:",
        outOf: "out of",
        players: "players",
        yourTotal: "üí™ Your total:",
        allianceLeader: "ü•á Alliance leader:",
        distanceFrom1: "üìä Distance from #1:",
        allianceAvg: "üìà Alliance average:",
        history: "üìÖ Update History",
        date: "Date",
        logout: "üö™ Logout",
        errorPlayerName: "Enter your player name",
        errorSecretCode: "Enter the alliance secret code",
        errorPIN: "Enter your PIN",
        errorInvalidCredentials: "Invalid credentials",
        generatingPIN: "‚è≥ Generating PIN...",
        loggingIn: "‚è≥ Logging in...",
        noChange: "‚û°Ô∏è No change"
      },
      fr: {
        title: "NGC - Statistiques Personnelles",
        firstTime: "üÜï Premi√®re fois? G√©n√©rer un PIN",
        alreadyHave: "‚úÖ J'ai d√©j√† un PIN",
        registerTitle: "üìù Inscription Nouveau Joueur",
        playerName: "Nom du Joueur",
        secretCode: "Code Secret de l'Alliance",
        generatePIN: "üîê G√©n√©rer un PIN",
        back: "‚Üê Retour",
        pinGenerated: "‚úÖ PIN G√©n√©r√© avec Succ√®s!",
        gotoLogin: "üöÄ Aller √† la Connexion",
        loginTitle: "üîê Connexion avec PIN",
        enterPIN: "Entrez le PIN",
        login: "üöÄ Se connecter",
        welcome: "üëã Bienvenue,",
        missiles: "üöÄ Missiles",
        aircraft: "‚úàÔ∏è Avions",
        tanks: "üöú Chars",
        total: "üí™ Total",
        trendGrowth: "üìà Tendance de Croissance (10 Derni√®res Mises √† Jour)",
        alliancePosition: "üèÜ Position dans l'Alliance",
        position: "Position:",
        outOf: "sur",
        players: "joueurs",
        yourTotal: "üí™ Votre total:",
        allianceLeader: "ü•á Chef de l'alliance:",
        distanceFrom1: "üìä Distance du #1:",
        allianceAvg: "üìà Moyenne de l'alliance:",
        history: "üìÖ Historique des Mises √† Jour",
        date: "Date",
        logout: "üö™ D√©connexion",
        errorPlayerName: "Entrez votre nom de joueur",
        errorSecretCode: "Entrez le code secret de l'alliance",
        errorPIN: "Entrez votre PIN",
        errorInvalidCredentials: "Identifiants invalides",
        generatingPIN: "‚è≥ G√©n√©ration du PIN...",
        loggingIn: "‚è≥ Connexion en cours...",
        noChange: "‚û°Ô∏è Aucun changement"
      }
    };

    function t(key) {
      return translations[currentLang][key] || key;
    }

    function updateLanguage() {
      document.title = t('title');
      
      const elements = {
        'firstTimeBtn': t('firstTime'),
        'havePINBtn': t('alreadyHave'),
        'generatePINBtn': t('generatePIN'),
        'backToChoiceBtn': t('back'),
        'backToChoice2Btn': t('back'),
        'gotoPINLoginBtn': t('gotoLogin'),
        'loginBtn': t('login'),
        'logoutBtn': t('logout')
      };

      Object.entries(elements).forEach(([id, text]) => {
        const el = document.getElementById(id);
        if (el && !el.disabled) el.textContent = text;
      });

      const regPlayerName = document.getElementById('regPlayerName');
      if (regPlayerName) regPlayerName.placeholder = t('playerName');
      
      const regSecretCode = document.getElementById('regSecretCode');
      if (regSecretCode) regSecretCode.placeholder = t('secretCode');
      
      const loginPlayerName = document.getElementById('loginPlayerName');
      if (loginPlayerName) loginPlayerName.placeholder = t('playerName');
      
      const loginPIN = document.getElementById('loginPIN');
      if (loginPIN) loginPIN.placeholder = t('enterPIN');
    }

    // NAVIGATION
    document.getElementById('firstTimeBtn').addEventListener('click', () => showSection('registerSection'));
    document.getElementById('havePINBtn').addEventListener('click', () => showSection('loginSection'));
    document.getElementById('backToChoiceBtn').addEventListener('click', () => {
      showSection('choiceSection');
      clearRegisterForm();
    });
    document.getElementById('backToChoice2Btn').addEventListener('click', () => {
      showSection('choiceSection');
      clearLoginForm();
    });
    document.getElementById('gotoPINLoginBtn').addEventListener('click', () => {
      const playerName = document.getElementById('generatedPlayerName').textContent;
      const pin = document.getElementById('generatedPIN').textContent;
      document.getElementById('loginPlayerName').value = playerName;
      document.getElementById('loginPIN').value = pin;
      showSection('loginSection');
    });

    function showSection(sectionId) {
      ['choiceSection', 'registerSection', 'pinDisplaySection', 'loginSection', 'dashboardSection'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
    }

    function clearRegisterForm() {
      document.getElementById('regPlayerName').value = '';
      document.getElementById('regSecretCode').value = '';
      document.getElementById('regErrorAlert').style.display = 'none';
    }

    function clearLoginForm() {
      document.getElementById('loginPlayerName').value = '';
      document.getElementById('loginPIN').value = '';
      document.getElementById('loginErrorAlert').style.display = 'none';
    }

    // GENERATE PIN
    document.getElementById('generatePINBtn').addEventListener('click', async () => {
      const playerName = document.getElementById('regPlayerName').value.trim();
      const secretCode = document.getElementById('regSecretCode').value.trim();
      const errorAlert = document.getElementById('regErrorAlert');
      const btn = document.getElementById('generatePINBtn');

      errorAlert.style.display = 'none';

      if (!playerName) {
        showError(errorAlert, t('errorPlayerName'));
        return;
      }

      if (!secretCode) {
        showError(errorAlert, t('errorSecretCode'));
        return;
      }

      btn.disabled = true;
      btn.textContent = t('generatingPIN');

      try {
        const url = `${SCRIPT_URL}?action=registerPlayer&playerName=${encodeURIComponent(playerName)}&secretCode=${encodeURIComponent(secretCode)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
          document.getElementById('generatedPIN').textContent = data.data.pin;
          document.getElementById('generatedPlayerName').textContent = data.data.playerName;
          showSection('pinDisplaySection');
        } else {
          showError(errorAlert, data.message || 'Errore durante la generazione del PIN');
        }
      } catch (error) {
        showError(errorAlert, 'Errore di connessione al server');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = t('generatePIN');
      }
    });

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const playerName = document.getElementById('loginPlayerName').value.trim();
      const pin = document.getElementById('loginPIN').value.trim();
      const errorAlert = document.getElementById('loginErrorAlert');
      const btn = document.getElementById('loginBtn');

      errorAlert.style.display = 'none';

      if (!playerName) {
        showError(errorAlert, t('errorPlayerName'));
        return;
      }

      if (!pin) {
        showError(errorAlert, t('errorPIN'));
        return;
      }

      btn.disabled = true;
      btn.textContent = t('loggingIn');

      try {
        const url = `${SCRIPT_URL}?action=getPlayerStats&playerName=${encodeURIComponent(playerName)}&pin=${encodeURIComponent(pin)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
          showDashboard(data.data);
        } else {
          showError(errorAlert, data.message || t('errorInvalidCredentials'));
        }
      } catch (error) {
        showError(errorAlert, 'Errore di connessione al server');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = t('login');
      }
    });

    function showError(element, message) {
      element.textContent = '‚ö†Ô∏è ' + message;
      element.style.display = 'block';
    }

    function showDashboard(data) {
      showSection('dashboardSection');
      
      document.getElementById('welcomeName').textContent = data.playerName;

      updateStatCard('Missile', data.trend.missile);
      updateStatCard('Aerei', data.trend.aerei);
      updateStatCard('Tank', data.trend.tank);
      updateStatCard('Total', data.trend.total);

      createChart(data.chartData);

      if (data.ranking) {
        document.getElementById('rankPosition').textContent = `#${data.ranking.position}`;
        
        let rankHtml = `
          <p>üìä ${t('position')} <strong>#${data.ranking.position}</strong> ${t('outOf')} ${data.ranking.total} ${t('players')}</p>
          <p>${t('yourTotal')} <strong>${formatNumber(data.ranking.playerTotal)}</strong></p>
          <p>${t('allianceLeader')} <strong>${formatNumber(data.ranking.topTotal)}</strong></p>
          <p>${t('distanceFrom1')} <strong>${formatNumber(data.ranking.gapFromTop)}</strong></p>
        `;
        
        if (data.ranking.allianceAverage) {
          const vsAvg = data.ranking.vsAverage >= 0 ? '+' : '';
          rankHtml += `<p>${t('allianceAvg')} <strong>${formatNumber(data.ranking.allianceAverage)}</strong></p>`;
        }
        
        document.getElementById('rankInfo').innerHTML = rankHtml;
      } else {
        document.getElementById('rankingSection').style.display = 'none';
      }

      createHistoryTable(data.history);
    }

    function updateStatCard(type, trend) {
      document.getElementById(`stat${type}`).textContent = formatNumber(trend.current);
      
      const changeEl = document.getElementById(`change${type}`);
      const change = trend.change;
      const percent = trend.percentChange;
      
      let arrow = '';
      let className = 'neutral';
      
      if (change > 0) {
        arrow = '‚¨ÜÔ∏è';
        className = 'positive';
      } else if (change < 0) {
        arrow = '‚¨áÔ∏è';
        className = 'negative';
      } else {
        arrow = '‚û°Ô∏è';
      }
      
      changeEl.className = 'stat-change ' + className;
      changeEl.textContent = `${arrow} ${change >= 0 ? '+' : ''}${formatNumber(change)} (${percent >= 0 ? '+' : ''}${percent}%)`;
    }

    function createChart(chartData) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      const missileData = chartData.map(d => d.missile);
      const aereiData = chartData.map(d => d.aerei);
      const tankData = chartData.map(d => d.tank);
      const totalData = chartData.map(d => d.total);
      const labels = chartData.map(d => formatDate(d.date));

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'üöÄ Missili',
              data: missileData,
              borderColor: '#ff6b6b',
              backgroundColor: 'rgba(255, 107, 107, 0.1)',
              tension: 0.3,
              borderWidth: 2
            },
            {
              label: '‚úàÔ∏è Aerei',
              data: aereiData,
              borderColor: '#4ecdc4',
              backgroundColor: 'rgba(78, 205, 196, 0.1)',
              tension: 0.3,
              borderWidth: 2
            },
            {
              label: 'üöú Tank',
              data: tankData,
              borderColor: '#ffe66d',
              backgroundColor: 'rgba(255, 230, 109, 0.1)',
              tension: 0.3,
              borderWidth: 2
            },
            {
              label: 'üí™ Totale',
              data: totalData,
              borderColor: '#90EE90',
              backgroundColor: 'rgba(144, 238, 144, 0.1)',
              borderWidth: 3,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#c4e3bf',
                font: { size: 11, family: "'Courier New', monospace" },
                padding: 8,
                boxWidth: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(30, 40, 30, 0.98)',
              titleColor: '#a8d5a3',
              bodyColor: '#c4e3bf',
              borderColor: '#4a6b47',
              borderWidth: 2,
              padding: 10,
              titleFont: { size: 12, weight: 'bold' },
              bodyFont: { size: 11 },
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + formatNumber(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: '#a8d5a3',
                font: { size: 10 },
                callback: function(value) {
                  return formatNumber(value);
                }
              },
              grid: { color: 'rgba(74, 107, 71, 0.3)' }
            },
            x: {
              ticks: { 
                color: '#a8d5a3',
                font: { size: 10 }
              },
              grid: { color: 'rgba(74, 107, 71, 0.3)' }
            }
          }
        }
      });
    }

    function createHistoryTable(history) {
      const container = document.getElementById('historyContainer');
      
      let html = '<table class="history-table"><thead><tr>';
      html += `<th>${t('date')}</th><th>${t('missiles')}</th><th>${t('aircraft')}</th><th>${t('tanks')}</th><th>${t('total')}</th>`;
      html += '</tr></thead><tbody>';
      
      const displayHistory = history.slice(0, 20);
      
      displayHistory.forEach(record => {
        const total = record.missile + record.aerei + record.tank;
        html += '<tr>';
        html += `<td>${formatDate(record.date)}</td>`;
        html += `<td>${formatNumber(record.missile)}</td>`;
        html += `<td>${formatNumber(record.aerei)}</td>`;
        html += `<td>${formatNumber(record.tank)}</td>`;
        html += `<td><strong>${formatNumber(total)}</strong></td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function formatNumber(num) {
      if (!num && num !== 0) return '0,00';
      let str = Math.floor(num).toString();
      while (str.length < 2) str = '0' + str;
      if (str.length === 2) return '0,' + str;
      if (str.length === 3) return str[0] + ',' + str.slice(1);
      if (str.length === 4) return str.slice(0, 2) + ',' + str.slice(2);
      return str.slice(0, -2) + ',' + str.slice(-2);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '-';
        return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
      } catch (e) {
        return '-';
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      showSection('choiceSection');
      clearLoginForm();
      clearRegisterForm();
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    });

    // LANGUAGE SELECTOR
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateLanguage();
        localStorage.setItem('ngc-lang', currentLang);
      });
    });

    const savedLang = localStorage.getItem('ngc-lang');
    if (savedLang && ['it', 'en', 'fr'].includes(savedLang)) {
      currentLang = savedLang;
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-lang="${savedLang}"]`).classList.add('active');
    }
    
    updateLanguage();

    // ‚úÖ CARICA CONFIG ALLEANZA ALL'AVVIO
    loadAllianceConfig();

    // Funzione per caricare configurazione alleanza
    async function loadAllianceConfig() {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getConfig`);
        const data = await response.json();
        
        if (data.status === 'success') {
          allianceConfig = data.data;
          applyAllianceConfig();
        }
      } catch (error) {
        console.error('Error loading alliance config:', error);
        // Usa valori di default se il caricamento fallisce
        allianceConfig = {
          alliance_name: 'Alliance',
          primary_color: '#4a6b47',
          secondary_color: '#2d4a2b',
          accent_color: '#7fa87a'
        };
        applyAllianceConfig();
      }
    }

    // Applica configurazione alleanza
    function applyAllianceConfig() {
      if (!allianceConfig) return;

      // Aggiorna nome alleanza nel logo
      const logoElement = document.querySelector('.ngc-logo');
      if (logoElement) {
        logoElement.textContent = allianceConfig.alliance_name.toUpperCase();
      }

      // Aggiorna titolo pagina
      const titleLang = {
        it: `${allianceConfig.alliance_name} - Statistiche Personali`,
        en: `${allianceConfig.alliance_name} - Personal Stats`,
        fr: `${allianceConfig.alliance_name} - Statistiques Personnelles`
      };
      document.title = titleLang[currentLang] || titleLang.en;

      // Applica colori personalizzati (opzionale)
      if (allianceConfig.primary_color) {
        document.documentElement.style.setProperty('--primary-color', allianceConfig.primary_color);
      }
      if (allianceConfig.secondary_color) {
        document.documentElement.style.setProperty('--secondary-color', allianceConfig.secondary_color);
      }
      if (allianceConfig.accent_color) {
        document.documentElement.style.setProperty('--accent-color', allianceConfig.accent_color);
      }
    }
  </script>
</body>
</html>
