<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Alliance Strategy Manager - Canyon & Desert Modes" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Alliance Strategy Manager</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .app-container {
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* HEADER */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .header-title {
      text-align: center;
      font-weight: 800;
      font-size: 24px;
      margin-bottom: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header-subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 16px;
    }

    /* MODE & LANGUAGE SWITCHER */
    .switcher-container {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .mode-switcher, .language-switcher {
      display: flex;
      gap: 8px;
      background: rgba(0, 0, 0, 0.2);
      padding: 6px;
      border-radius: 12px;
    }

    .mode-btn, .lang-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .mode-btn.active {
      background: white;
      color: #4f46e5;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .lang-btn.active {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: white;
      color: #4f46e5;
    }

    .btn-success {
      background: #22c55e;
      color: white;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    /* MAIN CONTENT */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .section {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 16px;
      color: #3b82f6;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* KILL SWAT */
    .kill-swat-section {
      background: linear-gradient(135deg, #dc2626, #991b1b);
    }

    /* RESERVES SECTION */
    .reserves-section {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .reserves-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.6;
    }

    .operators-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .operator-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .operator-input {
      flex: 1;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.95);
      color: #111827;
    }

    .operator-input:focus {
      outline: none;
      border-color: #fbbf24;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
    }

    .btn-remove {
      background: rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-remove:hover {
      background: rgba(0, 0, 0, 0.5);
      transform: scale(1.1);
    }

    .btn-add {
      background: rgba(255, 255, 255, 0.2);
      border: 2px dashed rgba(255, 255, 255, 0.4);
      border-radius: 10px;
      padding: 12px;
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-add:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
    }

    /* BUILDINGS GRID */
    .buildings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .building-card {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 12px;
      padding: 16px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }

    .building-card:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }

    .building-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .building-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      position: relative;
      flex-shrink: 0;
    }

    .protected-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #fbbf24;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .building-info {
      flex: 1;
    }

    .building-number {
      font-weight: 800;
      font-size: 18px;
      color: #3b82f6;
    }

    .building-type {
      font-size: 14px;
      color: #9ca3af;
      margin: 2px 0;
    }

    .building-rate {
      font-size: 14px;
      color: #22c55e;
      font-weight: 700;
    }

    .players-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .player-tag {
      background: rgba(34, 197, 94, 0.2);
      border-left: 3px solid #22c55e;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .no-players {
      color: #6b7280;
      font-size: 13px;
      font-style: italic;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }

    .modal {
      background: #0f172a;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      border: 2px solid #3b82f6;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 800;
      color: #3b82f6;
    }

    .modal-close {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: #ef4444;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-operators-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .modal-operator-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .modal-operator-input {
      flex: 1;
      border-radius: 10px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: #1e293b;
      color: white;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
    }

    .modal-operator-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .modal-footer {
      padding: 20px;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }

    .btn-full {
      width: 100%;
      border-radius: 12px;
      padding: 14px;
      border: none;
      font-weight: 800;
      font-size: 16px;
      background: #22c55e;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-full:hover {
      background: #16a34a;
      transform: translateY(-2px);
    }

    /* SCREENSHOT VIEW */
    .hidden {
      display: none !important;
    }

    .screenshot-view {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      padding: 0;
    }

    .screenshot-container {
      max-width: 100%;
      margin: 0 auto;
    }

    .screenshot-header {
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .screenshot-title {
      font-weight: 800;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .screenshot-mode {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .screenshot-date {
      font-size: 14px;
      opacity: 0.8;
    }

    .screenshot-kill-section {
      background: linear-gradient(135deg, #dc2626, #991b1b);
      color: white;
      padding: 16px;
      text-align: center;
    }

    .screenshot-reserves-section {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 16px;
      text-align: center;
    }

    .section-screenshot-title {
      font-weight: 800;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .tag {
      background: rgba(255, 255, 255, 0.25);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 700;
    }

    /* MAP SECTION */
    .map-section {
      background: rgba(15, 23, 42, 0.9);
      padding: 0;
    }

    .map-container {
      position: relative;
      border-radius: 0;
      height: 650px;
      overflow: hidden;
      box-shadow: none;
      margin-bottom: 0;
    }

    .map-building {
      position: absolute;
      transform: translate(-50%, -50%);
    }

    .map-building-tile {
      width: 70px;
      height: 70px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
      position: relative;
      font-size: 32px;
    }

    .map-protected-badge {
      position: absolute;
      top: -8px;
      left: -8px;
      background: #fbbf24;
      border-radius: 50%;
      border: 2px solid white;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }

    .map-id-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #000000;
      color: white;
      font-weight: 900;
      font-size: 14px;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
      border: 2px solid #4ade80;
    }

    .map-operators {
      position: absolute;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 80px;
    }

    .map-operators.left-column {
      left: 100%;
      top: 0;
      margin-left: 10px;
      align-items: flex-start;
    }

    .map-operators.right-column {
      right: 100%;
      top: 0;
      margin-right: 10px;
      align-items: flex-end;
    }

    .map-operators.center-column {
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 8px;
      align-items: center;
    }

    .map-operator-name {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 800;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    /* STRATEGY TEXT */
    .strategy-section {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 20px;
      margin: 20px;
      border: 2px solid rgba(34, 197, 94, 0.3);
    }

    .strategy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .strategy-title {
      font-weight: 800;
      font-size: 18px;
      color: #22c55e;
    }

    .btn-copy {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-copy:hover {
      background: #16a34a;
      transform: translateY(-2px);
    }

    .strategy-text-wrapper {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .strategy-text {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #4ade80;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .strategy-hint {
      margin-top: 12px;
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header-title {
        font-size: 20px;
      }

      .buildings-grid {
        grid-template-columns: 1fr;
      }

      .map-container {
        height: 450px;
      }

      .map-building-tile {
        width: 55px;
        height: 55px;
        font-size: 26px;
      }

      .map-operator-name {
        font-size: 9px;
        padding: 2px 8px;
      }

      .map-operators {
        min-width: 60px;
      }
    }
  </style>
</head>
<body>
<div class="app-container">
  <!-- HEADER -->
  <div class="header">
    <div class="header-title" id="headerTitle">üéØ Alliance Strategy Manager</div>
    <div class="header-subtitle" id="headerSubtitle">Tactical Coordination System</div>

    <!-- MODE & LANGUAGE SWITCHER -->
    <div class="switcher-container">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="canyon">üèîÔ∏è Canyon</button>
        <button class="mode-btn" data-mode="desert">üèúÔ∏è Desert</button>
      </div>
      <div class="language-switcher">
        <button class="lang-btn active" data-lang="en">üá¨üáß EN</button>
        <button class="lang-btn" data-lang="it">üáÆüáπ IT</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑ FR</button>
      </div>
    </div>

    <div class="header-buttons">
      <button id="btnLoadDb" class="btn btn-warning">üîÑ <span id="btnLoadText">Load Database</span></button>
      <button id="btnScreenshot" class="btn btn-primary">üì∏ <span id="btnPreviewText">Preview</span></button>
      <button id="btnCopyMain" class="btn btn-success">üìã <span id="btnCopyStrategyText">Copy Strategy</span></button>
    </div>
  </div>

  <!-- EDIT VIEW -->
  <div id="editView" class="main-content">
    <!-- KILL SWAT SECTION -->
    <div class="section kill-swat-section">
      <div class="section-title" id="killSwatTitle">‚ö° KILL SWAT - Mobile Strike Unit</div>
      <div id="killSwatList" class="operators-list"></div>
      <button id="btnAddKillSwat" class="btn-add">
        <span style="font-size: 20px;">+</span> <span id="addOperatorText">Add Operator</span>
      </button>
    </div>

    <!-- RESERVES SECTION -->
    <div class="section reserves-section">
      <div class="section-title" id="reservesTitle">üü® RESERVES - Backup Operators</div>
      <div class="reserves-info" id="reservesInfo">
        Reserves are ready to replace main operators when needed. Max 10 reserves.
      </div>
      <div id="reservesList" class="operators-list"></div>
      <button id="btnAddReserve" class="btn-add">
        <span style="font-size: 20px;">+</span> <span id="addReserveText">Add Reserve</span>
      </button>
    </div>

    <!-- BUILDINGS SECTION -->
    <div class="section">
      <div class="section-title" id="buildingsTitle">üè¢ Building Assignments</div>
      <div id="buildingsGrid" class="buildings-grid"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="modal-title">Building</div>
        <button id="modalClose" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalOperatorsList" class="modal-operators-list"></div>
        <button id="btnAddModalOperator" class="btn-add">
          <span style="font-size: 20px;">+</span> <span id="addModalOperatorText">Add Operator</span>
        </button>
      </div>
      <div class="modal-footer">
        <button id="modalSave" class="btn-full" id="modalSaveText">‚úì Save Assignments</button>
      </div>
    </div>
  </div>

  <!-- SCREENSHOT VIEW -->
  <div id="screenshotView" class="screenshot-view hidden">
    <div class="screenshot-container">
      <div id="screenshotCapture">
        <!-- Header -->
        <div class="screenshot-header">
          <div class="screenshot-title" id="screenshotAllianceName">Alliance Name</div>
          <div class="screenshot-mode" id="screenshotModeName">Canyon Mode</div>
          <div class="screenshot-date" id="screenshotDate"></div>
        </div>

        <!-- Kill Swat -->
        <div id="screenshotKillSection" class="screenshot-kill-section" style="display: none;">
          <div class="section-screenshot-title" id="screenshotKillTitle">‚ö° KILL SWAT</div>
          <div id="killTags" class="tags-container"></div>
        </div>

        <!-- Reserves -->
        <div id="screenshotReservesSection" class="screenshot-reserves-section" style="display: none;">
          <div class="section-screenshot-title" id="screenshotReservesTitle">üü® RESERVES</div>
          <div id="reservesTags" class="tags-container"></div>
        </div>

        <!-- Map -->
        <div class="map-section">
          <div id="mapContainer" class="map-container"></div>
        </div>
      </div>

      <!-- Strategy Text -->
      <div class="strategy-section">
        <div class="strategy-header">
          <div class="strategy-title" id="strategyTextTitle">üìã Full Strategy Text</div>
          <button id="btnCopyScreenshot" class="btn-copy">üìã <span id="btnCopyText">Copy Text</span></button>
        </div>
        <div class="strategy-text-wrapper">
          <pre id="strategyText" class="strategy-text"></pre>
        </div>
        <div class="strategy-hint" id="strategyHint">
          üí° Copy the text and share it in alliance chat
        </div>
      </div>

      <!-- Back Button -->
      <div style="margin-top: 20px; text-align: center; padding: 0 20px 20px;">
        <button id="btnBack" class="btn btn-primary" style="padding: 14px 32px; font-size: 16px;">
          ‚Üê <span id="btnBackText">Back to Edit</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== CONFIGURATION =====
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUh8QZSS776kD393oDBjSWbAksvV8Yop59T9JiwM44/dev';
// ===== TRANSLATIONS =====
const translations = {
  en: {
    title: "Alliance Strategy Manager",
    subtitle: "Tactical Coordination System",
    loadDb: "Load from Sheets",
    preview: "Preview",
    copyStrategy: "Copy Strategy",
    killSwat: "KILL SWAT - Mobile Strike Unit",
    reserves: "RESERVES - Backup Operators",
    reservesInfo: "Reserves are ready to replace main operators when needed. Max 10 reserves.",
    buildings: "Building Assignments",
    addOperator: "Add Operator",
    addReserve: "Add Reserve",
    saveAssignments: "Save Assignments",
    backToEdit: "Back to Edit",
    copyText: "Copy Text",
    strategyTitle: "Full Strategy Text",
    strategyHint: "Copy the text and share it in alliance chat",
    noOperators: "No operators assigned",
    operator: "Operator",
    building: "Building",
    canyon: "Canyon",
    desert: "Desert",
    canyonMode: "Canyon Mode",
    desertMode: "Desert Mode",
    saved: "Saved!",
    loaded: "Loaded!",
    copied: "Copied!",
    error: "Error"
  },
  it: {
    title: "Gestore Strategia Alleanza",
    subtitle: "Sistema di Coordinamento Tattico",
    loadDb: "Carica da Sheets",
    preview: "Anteprima",
    copyStrategy: "Copia Strategia",
    killSwat: "KILL SWAT - Unit√† Mobile d'Attacco",
    reserves: "RISERVE - Operatori di Backup",
    reservesInfo: "Le riserve sono pronte a sostituire gli operatori principali quando necessario. Max 10 riserve.",
    buildings: "Assegnazione Edifici",
    addOperator: "Aggiungi Operatore",
    addReserve: "Aggiungi Riserva",
    saveAssignments: "Salva Assegnazioni",
    backToEdit: "Torna alla Modifica",
    copyText: "Copia Testo",
    strategyTitle: "Testo Strategia Completa",
    strategyHint: "Copia il testo e condividilo nella chat dell'alleanza",
    noOperators: "Nessun operatore assegnato",
    operator: "Operatore",
    building: "Edificio",
    canyon: "Canyon",
    desert: "Desert",
    canyonMode: "Modalit√† Canyon",
    desertMode: "Modalit√† Desert",
    saved: "Salvato!",
    loaded: "Caricato!",
    copied: "Copiato!",
    error: "Errore"
  },
  fr: {
    title: "Gestionnaire de Strat√©gie d'Alliance",
    subtitle: "Syst√®me de Coordination Tactique",
    loadDb: "Charger de Sheets",
    preview: "Aper√ßu",
    copyStrategy: "Copier Strat√©gie",
    killSwat: "KILL SWAT - Unit√© Mobile d'Attaque",
    reserves: "R√âSERVES - Op√©rateurs de Backup",
    reservesInfo: "Les r√©serves sont pr√™tes √† remplacer les op√©rateurs principaux si n√©cessaire. Max 10 r√©serves.",
    buildings: "Affectation des B√¢timents",
    addOperator: "Ajouter Op√©rateur",
    addReserve: "Ajouter R√©serve",
    saveAssignments: "Sauvegarder Affectations",
    backToEdit: "Retour √† l'√âdition",
    copyText: "Copier Texte",
    strategyTitle: "Texte Complet de la Strat√©gie",
    strategyHint: "Copiez le texte et partagez-le dans le chat de l'alliance",
    noOperators: "Aucun op√©rateur assign√©",
    operator: "Op√©rateur",
    building: "B√¢timent",
    canyon: "Canyon",
    desert: "D√©sert",
    canyonMode: "Mode Canyon",
    desertMode: "Mode D√©sert",
    saved: "Sauvegard√©!",
    loaded: "Charg√©!",
    copied: "Copi√©!",
    error: "Erreur"
  }
};

// ===== MODE CONFIGURATIONS =====
const modeConfigs = {
  canyon: {
    mapColor: "radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 50%), linear-gradient(135deg, #1a1f3a 0%, #0d1224 50%, #1a1f3a 100%)",
    buildings: [
      { id: 1, x: 20, y: 15, rate: 25, type: { en: "Data Center", it: "Data Center", fr: "Centre de Donn√©es" }, icon: "üíæ", color: "#3b82f6" },
      { id: 2, x: 80, y: 15, rate: 25, type: { en: "Data Center", it: "Data Center", fr: "Centre de Donn√©es" }, icon: "üíæ", color: "#3b82f6" },
      { id: 3, x: 20, y: 32, rate: 20, type: { en: "Serum Factory", it: "Fabbrica Sieri", fr: "Usine de S√©rum" }, icon: "üß¨", color: "#8b5cf6" },
      { id: 4, x: 50, y: 32, rate: 40, type: { en: "Power Tower", it: "Torre Energia", fr: "Tour d'√ânergie" }, icon: "‚ö°", color: "#f59e0b" },
      { id: 5, x: 80, y: 32, rate: 20, type: { en: "Defense System", it: "Sistema Difesa", fr: "Syst√®me D√©fense" }, icon: "üõ°Ô∏è", color: "#ef4444" },
      { id: 6, x: 20, y: 49, rate: 20, type: { en: "Defense System", it: "Sistema Difesa", fr: "Syst√®me D√©fense" }, icon: "üõ°Ô∏è", color: "#ef4444" },
      { id: 7, x: 50, y: 49, rate: 100, protected: true, type: { en: "Virus Lab", it: "Laboratorio Virus", fr: "Labo Virus" }, icon: "‚ò£Ô∏è", color: "#22c55e" },
      { id: 8, x: 80, y: 49, rate: 20, type: { en: "Serum Factory", it: "Fabbrica Sieri", fr: "Usine de S√©rum" }, icon: "üß¨", color: "#8b5cf6" },
      { id: 9, x: 20, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 10, x: 40, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 11, x: 60, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 12, x: 80, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" }
    ]
  },
  desert: {
    mapColor: "linear-gradient(135deg, #d97706, #b45309)",
    buildings: [
      { id: 1, x: 90, y: 15, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 2, x: 90, y: 32, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 3, x: 10, y: 78, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 4, x: 10, y: 55, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 5, x: 10, y: 32, rate: 50, type: { en: "Refinery", it: "Raffineria", fr: "Raffinerie" }, icon: "‚öôÔ∏è", color: "#64748b" },
      { id: 6, x: 90, y: 78, rate: 10, type: { en: "Info Center", it: "Centro Info", fr: "Centre Info" }, icon: "‚ÑπÔ∏è", color: "#3b82f6" },
      { id: 7, x: 10, y: 15, rate: 10, type: { en: "Tech Center", it: "Centro Tech", fr: "Centre Tech" }, icon: "üì°", color: "#8b5cf6" },
      { id: 8, x: 90, y: 55, rate: 50, type: { en: "Refinery", it: "Raffineria", fr: "Raffinerie" }, icon: "‚öôÔ∏è", color: "#64748b" },
      { id: 9, x: 50, y: 74, rate: 10, protected: true, type: { en: "Merc Factory", it: "Fabbrica", fr: "Usine Mercs" }, icon: "üè≠", color: "#f59e0b" },
      { id: 10, x: 50, y: 22, rate: 10, protected: true, type: { en: "Arsenal", it: "Arsenale", fr: "Arsenal" }, icon: "üî´", color: "#475569" },
      { id: 11, x: 50, y: 48, rate: 80, protected: true, type: { en: "Nuclear Silo", it: "Silo Nucleare", fr: "Silo Nucl√©aire" }, icon: "‚ò¢Ô∏è", color: "#22c55e" }
    ]
  }
};

// ===== STATE =====
let currentMode = 'canyon';
let currentLang = 'en';
let players = {};
let allianceConfig = {
  alliance_name: "NGC",
  alliance_color: "#4a6b47",
  alliance_logo: "üéØ",
  tagline: "Tactical Warfare Division"
};
let selectedBuildingId = null;

// ===== INIT =====
function init() {
  loadFromLocalStorage();
  loadAllianceConfig();
  setupEventListeners();
  updateUI();
}

// ===== STORAGE =====
function loadFromLocalStorage() {
  try {
    const savedMode = localStorage.getItem("allianceStrategyMode");
    if (savedMode) currentMode = savedMode;

    const savedLang = localStorage.getItem("allianceStrategyLang");
    if (savedLang) currentLang = savedLang;

    const canyonData = localStorage.getItem("canyonPlayers");
    const desertData = localStorage.getItem("desertPlayers");

    players.canyon = canyonData ? JSON.parse(canyonData) : initializePlayers('canyon');
    players.desert = desertData ? JSON.parse(desertData) : initializePlayers('desert');
  } catch (e) {
    console.error("Error loading from localStorage:", e);
    players.canyon = initializePlayers('canyon');
    players.desert = initializePlayers('desert');
  }
}

function initializePlayers(mode) {
  const data = { killSwat: [], reserves: [] };
  modeConfigs[mode].buildings.forEach(b => {
    data[b.id] = [];
  });
  return data;
}

function saveToLocalStorage() {
  localStorage.setItem("allianceStrategyMode", currentMode);
  localStorage.setItem("allianceStrategyLang", currentLang);
  localStorage.setItem("canyonPlayers", JSON.stringify(players.canyon));
  localStorage.setItem("desertPlayers", JSON.stringify(players.desert));
}

// ===== ALLIANCE CONFIG =====
async function loadAllianceConfig() {
  if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
    return;
  }

  try {
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getConfig`);
    const result = await response.json();
    if (result.status === 'success') {
      // Mappa campi del tuo script ‚Üí campi app
      const config = result.data;
      allianceConfig = {
        alliance_name: config.alliance_name || 'NGC',
        alliance_logo: config.logo_url ? `<img src="${config.logo_url}" style="height:24px">` : 'üéØ',
        alliance_color: config.primary_color || '#4a6b47',
        tagline: config.announcement || 'Tactical Warfare Division'
      };
      updateUI();
    }
  } catch (e) {
    console.error("Error loading alliance config:", e);
  }
}

// ===== CONVERSIONE FORMATI API ‚Üî APP =====

/**
 * Converte dal formato API (teamA/teamB con building names) al formato APP (edifici numerati)
 */
function convertAPIToApp(apiData, mode) {
  const appData = { killSwat: [], reserves: [] };
  const buildings = modeConfigs[mode].buildings;
  
  // Inizializza tutti gli edifici vuoti
  buildings.forEach(b => {
    appData[b.id] = [];
  });
  
  // Mappa nome edificio ‚Üí ID edificio
  const buildingNameToId = {};
  buildings.forEach(b => {
    // Prova tutte le lingue
    Object.values(b.type).forEach(name => {
      buildingNameToId[name.toLowerCase()] = b.id;
    });
    // Aggiungi anche pattern comuni
    buildingNameToId[`building ${b.id}`] = b.id;
    buildingNameToId[`edificio ${b.id}`] = b.id;
  });
  
  // Processa teamA e teamB
  const allPlayers = [...(apiData.teamA || []), ...(apiData.teamB || [])];
  
  allPlayers.forEach(entry => {
    const player = entry.player;
    const building = (entry.building || '').toLowerCase().trim();
    const role = (entry.role || '').toLowerCase();
    const killSwat = (entry.killSwat || '').toUpperCase();
    
    // Kill Swat
    if (killSwat === 'YES' && player && !appData.killSwat.includes(player)) {
      appData.killSwat.push(player);
    }
    
    // Riserve
    if (role === 'reserve' && player && !appData.reserves.includes(player)) {
      appData.reserves.push(player);
    }
    
    // Assegnazione edificio
    if (building && player) {
      // Cerca ID edificio
      let buildingId = null;
      
      // Cerca match diretto
      if (buildingNameToId[building]) {
        buildingId = buildingNameToId[building];
      } else {
        // Cerca pattern "Building X" o "Edificio X"
        const match = building.match(/(?:building|edificio|ed\.)\s*(\d+)/i);
        if (match) {
          buildingId = parseInt(match[1]);
        }
      }
      
      if (buildingId && appData[buildingId] && !appData[buildingId].includes(player)) {
        appData[buildingId].push(player);
      }
    }
  });
  
  return appData;
}

/**
 * Converte dal formato APP (edifici numerati) al formato API (teamA/teamB con building names)
 */
function convertAppToAPI(appData, mode) {
  const apiData = { teamA: [], teamB: [] };
  const buildings = modeConfigs[mode].buildings;
  
  // Kill Swat e Reserves vanno in entrambi i team per ora
  const killSwatSet = new Set(appData.killSwat || []);
  const reservesSet = new Set(appData.reserves || []);
  
  // Raccogli tutti i giocatori con edifici assegnati
  const allAssigned = [];
  buildings.forEach(b => {
    (appData[b.id] || []).forEach(player => {
      if (player && player.trim()) {
        allAssigned.push({
          player: player.trim(),
          buildingId: b.id,
          buildingName: b.type.en // Usa nome inglese
        });
      }
    });
  });
  
  // Dividi in Team A e Team B (50/50)
  const half = Math.ceil(allAssigned.length / 2);
  
  allAssigned.forEach((item, index) => {
    const team = index < half ? 'A' : 'B';
    const entry = {
      player: item.player,
      building: item.buildingName,
      killSwat: killSwatSet.has(item.player) ? 'YES' : 'NO',
      role: reservesSet.has(item.player) ? 'Reserve' : 'Main'
    };
    
    if (team === 'A') {
      apiData.teamA.push(entry);
    } else {
      apiData.teamB.push(entry);
    }
  });
  
  // Aggiungi riserve non ancora incluse
  reservesSet.forEach(player => {
    const alreadyAdded = apiData.teamA.some(e => e.player === player) || 
                         apiData.teamB.some(e => e.player === player);
    if (!alreadyAdded) {
      apiData.teamA.push({
        player: player,
        building: '',
        killSwat: killSwatSet.has(player) ? 'YES' : 'NO',
        role: 'Reserve'
      });
    }
  });
  
  return apiData;
}

// ===== DATABASE OPERATIONS =====
async function saveToDatabase() {
  if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
    alert("Please configure GOOGLE_SCRIPT_URL first!");
    return;
  }

  // Il tuo script non ha endpoint di salvataggio esposti via POST
  // Quindi salviamo solo in localStorage per ora
  saveToLocalStorage();
  showButtonFeedback('btnSaveDb', translations[currentLang].saved);
  
  // NOTA: Il tuo script Google attuale aggiorna la strategia tramite 
  // il menu interno "Aggiorna Canyon Strategy" / "Aggiorna Storm Strategy"
  // Non ha endpoint POST per salvare direttamente dall'app web
  
  console.log("Data saved to localStorage. To sync with Google Sheets, use the menu in Google Sheets.");
}

async function loadFromDatabase() {
  if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
    alert("Please configure GOOGLE_SCRIPT_URL first!");
    return;
  }

  // Mappa: canyon ‚Üí getCanyonStrategy, desert ‚Üí getStormStrategy (Storm nel tuo script)
  const action = currentMode === 'canyon' ? 'getCanyonStrategy' : 'getStormStrategy';

  try {
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=${action}`);
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      // Converti formato API (teamA/teamB + building) ‚Üí formato app (edifici numerati)
      players[currentMode] = convertAPIToApp(result.data, currentMode);
      saveToLocalStorage();
      renderEditView();
      showButtonFeedback('btnLoadDb', translations[currentLang].loaded);
    }
  } catch (e) {
    console.error("Error loading from database:", e);
    alert(translations[currentLang].error + ": " + e.message);
  }
}

function showButtonFeedback(btnId, text) {
  const btn = document.getElementById(btnId);
  const originalHTML = btn.innerHTML;
  btn.innerHTML = `‚úÖ ${text}`;
  btn.style.background = "#16a34a";
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.style.background = "";
  }, 2000);
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  // Mode switcher
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.dataset.mode;
      saveToLocalStorage();
      updateUI();
    });
  });

  // Language switcher
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentLang = btn.dataset.lang;
      saveToLocalStorage();
      updateUI();
    });
  });

  // Buttons
  document.getElementById('btnLoadDb').addEventListener('click', loadFromDatabase);
  document.getElementById('btnScreenshot').addEventListener('click', showScreenshotView);
  document.getElementById('btnCopyMain').addEventListener('click', () => copyStrategy('btnCopyMain'));
  document.getElementById('btnBack').addEventListener('click', showEditView);
  document.getElementById('btnCopyScreenshot').addEventListener('click', () => copyStrategy('btnCopyScreenshot'));

  // Kill Swat
  document.getElementById('btnAddKillSwat').addEventListener('click', () => {
    players[currentMode].killSwat.push("");
    saveToLocalStorage();
    renderKillSwatList();
  });

  // Reserves
  document.getElementById('btnAddReserve').addEventListener('click', () => {
    if (players[currentMode].reserves.length >= 10) {
      alert("Maximum 10 reserves!");
      return;
    }
    players[currentMode].reserves.push("");
    saveToLocalStorage();
    renderReservesList();
  });

  // Modal
  document.getElementById('btnAddModalOperator').addEventListener('click', () => {
    if (selectedBuildingId) {
      players[currentMode][selectedBuildingId].push("");
      renderModalOperatorsList();
    }
  });

  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('modalSave').addEventListener('click', saveModal);
  document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
  });
}

// ===== UPDATE UI =====
function updateUI() {
  const t = translations[currentLang];

  // Update text content
  document.getElementById('headerTitle').textContent = `${allianceConfig.alliance_logo} ${t.title}`;
  document.getElementById('headerSubtitle').textContent = allianceConfig.tagline;
  document.getElementById('btnLoadText').textContent = t.loadDb;
  document.getElementById('btnPreviewText').textContent = t.preview;
  document.getElementById('btnCopyStrategyText').textContent = t.copyStrategy;
  document.getElementById('killSwatTitle').textContent = `‚ö° ${t.killSwat}`;
  document.getElementById('reservesTitle').textContent = `üü® ${t.reserves}`;
  document.getElementById('reservesInfo').textContent = t.reservesInfo;
  document.getElementById('buildingsTitle').textContent = `üè¢ ${t.buildings}`;
  document.getElementById('addOperatorText').textContent = t.addOperator;
  document.getElementById('addReserveText').textContent = t.addReserve;
  document.getElementById('addModalOperatorText').textContent = t.addOperator;
  document.getElementById('modalSave').textContent = `‚úì ${t.saveAssignments}`;
  document.getElementById('btnBackText').textContent = t.backToEdit;
  document.getElementById('btnCopyText').textContent = t.copyText;
  document.getElementById('strategyTextTitle').textContent = `üìã ${t.strategyTitle}`;
  document.getElementById('strategyHint').textContent = `üí° ${t.strategyHint}`;

  renderEditView();
}

// ===== RENDER FUNCTIONS =====
function renderKillSwatList() {
  const container = document.getElementById('killSwatList');
  const data = players[currentMode].killSwat;
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    data.push("");
  }

  data.forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'operator-item';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'operator-input';
    input.placeholder = `${t.operator} ${index + 1}`;
    input.value = name || "";
    input.addEventListener('input', (e) => {
      players[currentMode].killSwat[index] = e.target.value;
      saveToLocalStorage();
    });

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode].killSwat.splice(index, 1);
      saveToLocalStorage();
      renderKillSwatList();
    });

    item.appendChild(input);
    if (data.length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function renderReservesList() {
  const container = document.getElementById('reservesList');
  const data = players[currentMode].reserves;
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    data.push("");
  }

  data.forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'operator-item';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'operator-input';
    input.placeholder = `${t.operator} ${index + 1}`;
    input.value = name || "";
    input.addEventListener('input', (e) => {
      players[currentMode].reserves[index] = e.target.value;
      saveToLocalStorage();
    });

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode].reserves.splice(index, 1);
      saveToLocalStorage();
      renderReservesList();
    });

    item.appendChild(input);
    if (data.length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function renderEditView() {
  renderKillSwatList();
  renderReservesList();

  const grid = document.getElementById('buildingsGrid');
  const buildings = modeConfigs[currentMode].buildings;
  const t = translations[currentLang];

  grid.innerHTML = "";

  buildings.forEach(b => {
    const card = document.createElement('div');
    card.className = 'building-card';

    const header = document.createElement('div');
    header.className = 'building-header';

    const icon = document.createElement('div');
    icon.className = 'building-icon';
    icon.style.backgroundColor = b.color;
    icon.textContent = b.icon;

    if (b.protected) {
      const badge = document.createElement('div');
      badge.className = 'protected-badge';
      badge.textContent = 'üõ°Ô∏è';
      icon.appendChild(badge);
    }

    const info = document.createElement('div');
    info.className = 'building-info';
    info.innerHTML = `
      <div class="building-number">${t.building} ${b.id}</div>
      <div class="building-type">${b.type[currentLang]}</div>
      <div class="building-rate">+${b.rate}/s</div>
    `;

    header.appendChild(icon);
    header.appendChild(info);

    const playersList = document.createElement('div');
    playersList.className = 'players-list';

    const assigned = (players[currentMode][b.id] || []).filter(p => p && p.trim() !== "");
    if (assigned.length > 0) {
      assigned.forEach(p => {
        const tag = document.createElement('div');
        tag.className = 'player-tag';
        tag.textContent = 'üë§ ' + p;
        playersList.appendChild(tag);
      });
    } else {
      const noPlayers = document.createElement('div');
      noPlayers.className = 'no-players';
      noPlayers.textContent = t.noOperators;
      playersList.appendChild(noPlayers);
    }

    card.appendChild(header);
    card.appendChild(playersList);

    card.addEventListener('click', () => openModal(b.id));

    grid.appendChild(card);
  });
}

// ===== MODAL =====
function openModal(id) {
  selectedBuildingId = id;
  const buildings = modeConfigs[currentMode].buildings;
  const building = buildings.find(b => b.id === id);
  const t = translations[currentLang];

  document.getElementById('modalTitle').textContent = `${t.building} ${id} - ${building.type[currentLang]}`;

  renderModalOperatorsList();

  document.getElementById('modalOverlay').style.display = 'flex';
}

function renderModalOperatorsList() {
  const container = document.getElementById('modalOperatorsList');
  const data = players[currentMode][selectedBuildingId] || [];
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    players[currentMode][selectedBuildingId] = [""];
  }

  players[currentMode][selectedBuildingId].forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'modal-operator-item';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'modal-operator-input';
    input.placeholder = `${t.operator} ${index + 1}`;
    input.value = name || "";
    input.dataset.index = index;

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode][selectedBuildingId].splice(index, 1);
      renderModalOperatorsList();
    });

    item.appendChild(input);
    if (players[currentMode][selectedBuildingId].length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  selectedBuildingId = null;
}

function saveModal() {
  if (!selectedBuildingId) return;

  const inputs = document.querySelectorAll('#modalOperatorsList .modal-operator-input');
  players[currentMode][selectedBuildingId] = Array.from(inputs).map(input => input.value || "");

  saveToLocalStorage();
  renderEditView();
  closeModal();
}

// ===== SCREENSHOT VIEW =====
function renderScreenshotView() {
  const t = translations[currentLang];
  const buildings = modeConfigs[currentMode].buildings;

  // Header
  document.getElementById('screenshotAllianceName').textContent = `${allianceConfig.alliance_logo} ${allianceConfig.alliance_name}`;
  document.getElementById('screenshotModeName').textContent = currentMode === 'canyon' ? t.canyonMode : t.desertMode;
  
  const dateStr = new Date().toLocaleDateString(currentLang, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  document.getElementById('screenshotDate').textContent = dateStr;

  // Kill Swat
  const killSection = document.getElementById('screenshotKillSection');
  const killTags = document.getElementById('killTags');
  const ks = (players[currentMode].killSwat || []).filter(p => p && p.trim() !== "");

  killTags.innerHTML = "";
  if (ks.length > 0) {
    killSection.style.display = "block";
    document.getElementById('screenshotKillTitle').textContent = "‚ö° KILL SWAT";
    ks.forEach(p => {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = p;
      killTags.appendChild(tag);
    });
  } else {
    killSection.style.display = "none";
  }

  // Reserves
  const reservesSection = document.getElementById('screenshotReservesSection');
  const reservesTags = document.getElementById('reservesTags');
  const reserves = (players[currentMode].reserves || []).filter(p => p && p.trim() !== "");

  reservesTags.innerHTML = "";
  if (reserves.length > 0) {
    reservesSection.style.display = "block";
    document.getElementById('screenshotReservesTitle').textContent = "üü® " + t.reserves.split(' - ')[0];
    reserves.forEach(p => {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = p;
      reservesTags.appendChild(tag);
    });
  } else {
    reservesSection.style.display = "none";
  }

  // Map
  const mapContainer = document.getElementById('mapContainer');
  mapContainer.style.background = modeConfigs[currentMode].mapColor;
  mapContainer.innerHTML = "";

  buildings.forEach(b => {
    const wrapper = document.createElement('div');
    wrapper.className = 'map-building';
    wrapper.style.left = b.x + '%';
    wrapper.style.top = b.y + '%';

    const tile = document.createElement('div');
    tile.className = 'map-building-tile';
    tile.style.backgroundColor = b.color;

    if (b.protected) {
      const protectedBadge = document.createElement('div');
      protectedBadge.className = 'map-protected-badge';
      protectedBadge.textContent = 'üõ°Ô∏è';
      tile.appendChild(protectedBadge);
    }

    const idBadge = document.createElement('div');
    idBadge.className = 'map-id-badge';
    idBadge.textContent = b.id;
    tile.appendChild(idBadge);

    const icon = document.createElement('div');
    icon.textContent = b.icon;
    tile.appendChild(icon);

    wrapper.appendChild(tile);

    // Operators
    const assigned = (players[currentMode][b.id] || []).filter(p => p && p.trim() !== "");
    if (assigned.length > 0) {
      const operatorsDiv = document.createElement('div');
      operatorsDiv.className = 'map-operators';

      if (b.x < 30) {
        operatorsDiv.classList.add('left-column');
      } else if (b.x > 70) {
        operatorsDiv.classList.add('right-column');
      } else {
        operatorsDiv.classList.add('center-column');
      }

      assigned.forEach(p => {
        const nameDiv = document.createElement('div');
        nameDiv.className = 'map-operator-name';
        nameDiv.textContent = p;
        operatorsDiv.appendChild(nameDiv);
      });

      wrapper.appendChild(operatorsDiv);
    }

    mapContainer.appendChild(wrapper);
  });

  // Strategy Text
  document.getElementById('strategyText').textContent = generateStrategyText();
}

// ===== GENERATE STRATEGY TEXT =====
function generateStrategyText() {
  const t = translations[currentLang];
  const buildings = modeConfigs[currentMode].buildings;

  const killSwatNames = (players[currentMode].killSwat || [])
    .filter(p => p && p.trim() !== "")
    .join(", ") || "**********";

  const reservesNames = (players[currentMode].reserves || [])
    .filter(p => p && p.trim() !== "")
    .join(", ") || "**********";

  const getNames = (ids) => {
    const all = [];
    ids.forEach(id => {
      (players[currentMode][id] || []).forEach(p => {
        if (p && p.trim() !== "") all.push(p.trim());
      });
    });
    return all.join(", ") || "**********";
  };

  const dateStr = new Date().toLocaleDateString(currentLang, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  const modeName = currentMode === 'canyon' ? t.canyon : t.desert;

  let text = `${allianceConfig.alliance_name.toUpperCase()} - ${modeName.toUpperCase()} STRATEGY\n\n`;
  text += `Date: ${dateStr}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  
  text += `‚ö° KILL SWAT\n\n`;
  text += `Operators: ${killSwatNames}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

  buildings.forEach(b => {
    text += `${b.icon} ${b.type[currentLang].toUpperCase()} - BUILDING ${b.id}\n`;
    text += `Rate: +${b.rate}/s${b.protected ? ' (Protected)' : ''}\n`;
    text += `Operators: ${getNames([b.id])}\n\n`;
  });

  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  text += `üü® RESERVES\n\n`;
  text += `Operators: ${reservesNames}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  text += `üí™ ${allianceConfig.alliance_name.toUpperCase()}! üí™`;

  return text;
}

// ===== COPY TO CLIPBOARD =====
function copyStrategy(btnId) {
  const text = generateStrategyText();
  const t = translations[currentLang];

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showCopyFeedback(btnId, t.copied);
    }).catch(() => {
      fallbackCopy(text);
      showCopyFeedback(btnId, t.copied);
    });
  } else {
    fallbackCopy(text);
    showCopyFeedback(btnId, t.copied);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
  } catch (e) {}
  document.body.removeChild(textarea);
}

function showCopyFeedback(btnId, text) {
  const btn = document.getElementById(btnId);
  const originalHTML = btn.innerHTML;
  btn.innerHTML = `‚úÖ ${text}`;
  btn.style.background = '#16a34a';

  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.style.background = '';
  }, 2000);
}

// ===== NAVIGATION =====
function showScreenshotView() {
  renderScreenshotView();
  document.getElementById('editView').classList.add('hidden');
  document.querySelector('.header').classList.add('hidden');
  document.getElementById('screenshotView').classList.remove('hidden');
  window.scrollTo(0, 0);
}

function showEditView() {
  document.getElementById('screenshotView').classList.add('hidden');
  document.querySelector('.header').classList.remove('hidden');
  document.getElementById('editView').classList.remove('hidden');
}

// ===== START =====
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
