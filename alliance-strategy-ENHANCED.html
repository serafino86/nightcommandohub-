<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Alliance Strategy Manager - Canyon & Desert Modes" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Alliance Strategy Manager</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

body {
font-family: -apple-system, BlinkMacSystemFont, ‚ÄúSegoe UI‚Äù, Arial, sans-serif;
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
color: #e5e7eb;
min-height: 100vh;
}

.app-container {
min-height: 100vh;
padding-bottom: 40px;
}

/* HEADER */
.header {
position: sticky;
top: 0;
z-index: 50;
background: linear-gradient(90deg, #2563eb, #4f46e5);
color: white;
padding: 20px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.header-title {
text-align: center;
font-weight: 800;
font-size: 24px;
margin-bottom: 16px;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.header-subtitle {
text-align: center;
font-size: 14px;
opacity: 0.9;
margin-bottom: 16px;
}

/* MODE & LANGUAGE SWITCHER */
.switcher-container {
display: flex;
justify-content: center;
gap: 16px;
margin-bottom: 16px;
flex-wrap: wrap;
}

.mode-switcher, .language-switcher {
display: flex;
gap: 8px;
background: rgba(0, 0, 0, 0.2);
padding: 6px;
border-radius: 12px;
}

.mode-btn, .lang-btn {
padding: 10px 20px;
border: none;
border-radius: 8px;
font-weight: 700;
font-size: 14px;
cursor: pointer;
transition: all 0.2s;
background: rgba(255, 255, 255, 0.1);
color: white;
}

.mode-btn.active {
background: white;
color: #4f46e5;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.lang-btn.active {
background: rgba(255, 255, 255, 0.3);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* TEAM SELECTOR */
.team-selector {
display: flex;
gap: 8px;
background: rgba(0, 0, 0, 0.2);
padding: 6px;
border-radius: 12px;
}

.team-btn {
padding: 10px 20px;
border: none;
border-radius: 8px;
font-weight: 700;
font-size: 14px;
cursor: pointer;
transition: all 0.2s;
background: rgba(255, 255, 255, 0.1);
color: white;
}

.team-btn.active {
background: white;
color: #4f46e5;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* TACTICAL COMMANDS IN DROPDOWN */
.tactical-command {
color: #ff9800 !important;
font-weight: bold !important;
font-style: italic;
}

.header-buttons {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 12px;
}

.btn {
border: none;
border-radius: 12px;
padding: 12px 24px;
font-weight: 700;
font-size: 15px;
cursor: pointer;
transition: all 0.2s;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
}

.btn:active {
transform: translateY(0);
}

.btn-primary {
background: white;
color: #4f46e5;
}

.btn-success {
background: #22c55e;
color: white;
}

.btn-warning {
background: #f59e0b;
color: white;
}

/* MAIN CONTENT */
.main-content {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}

.section {
background: rgba(15, 23, 42, 0.8);
border-radius: 16px;
padding: 24px;
margin-bottom: 24px;
border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
font-size: 20px;
font-weight: 800;
margin-bottom: 16px;
color: #3b82f6;
display: flex;
align-items: center;
gap: 8px;
}

/* KILL SWAT */
.kill-swat-section {
background: linear-gradient(135deg, #dc2626, #991b1b);
}

/* RESERVES SECTION */
.reserves-section {
background: linear-gradient(135deg, #f59e0b, #d97706);
}

.reserves-info {
background: rgba(0, 0, 0, 0.3);
border-radius: 10px;
padding: 12px;
margin-bottom: 16px;
font-size: 14px;
line-height: 1.6;
}

.operators-list {
display: flex;
flex-direction: column;
gap: 10px;
margin-bottom: 12px;
}

.operator-item {
display: flex;
gap: 8px;
align-items: center;
}

.operator-input {
flex: 1;
border-radius: 10px;
border: 2px solid rgba(255, 255, 255, 0.2);
padding: 12px 16px;
font-size: 16px;
font-weight: 600;
background: rgba(255, 255, 255, 0.95);
color: #111827;
}

.operator-input:focus {
outline: none;
border-color: #fbbf24;
box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
}

.btn-remove {
background: rgba(0, 0, 0, 0.3);
border: none;
border-radius: 8px;
width: 40px;
height: 40px;
cursor: pointer;
color: white;
font-size: 20px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.btn-remove:hover {
background: rgba(0, 0, 0, 0.5);
transform: scale(1.1);
}

.btn-add {
background: rgba(255, 255, 255, 0.2);
border: 2px dashed rgba(255, 255, 255, 0.4);
border-radius: 10px;
padding: 12px;
color: white;
font-weight: 700;
font-size: 15px;
cursor: pointer;
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}

.btn-add:hover {
background: rgba(255, 255, 255, 0.3);
border-color: rgba(255, 255, 255, 0.6);
}

/* BUILDINGS GRID */
.buildings-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 16px;
}

.building-card {
background: linear-gradient(135deg, #1e293b, #0f172a);
border-radius: 12px;
padding: 16px;
border: 2px solid rgba(59, 130, 246, 0.3);
cursor: pointer;
transition: all 0.2s;
}

.building-card:hover {
border-color: #3b82f6;
transform: translateY(-4px);
box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
}

.building-header {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 12px;
}

.building-icon {
width: 60px;
height: 60px;
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 32px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
position: relative;
flex-shrink: 0;
}

.protected-badge {
position: absolute;
top: -6px;
right: -6px;
background: #fbbf24;
border-radius: 50%;
width: 24px;
height: 24px;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.building-info {
flex: 1;
}

.building-number {
font-weight: 800;
font-size: 18px;
color: #3b82f6;
}

.building-type {
font-size: 14px;
color: #9ca3af;
margin: 2px 0;
}

.building-rate {
font-size: 14px;
color: #22c55e;
font-weight: 700;
}

.players-list {
display: flex;
flex-direction: column;
gap: 6px;
}

.player-tag {
background: rgba(34, 197, 94, 0.2);
border-left: 3px solid #22c55e;
padding: 6px 10px;
border-radius: 6px;
font-size: 14px;
font-weight: 600;
}

.no-players {
color: #6b7280;
font-size: 13px;
font-style: italic;
}

/* MODAL */
.modal-overlay {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.85);
backdrop-filter: blur(6px);
display: none;
align-items: center;
justify-content: center;
z-index: 100;
padding: 20px;
}

.modal {
background: #0f172a;
border-radius: 20px;
max-width: 500px;
width: 100%;
border: 2px solid #3b82f6;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
max-height: 90vh;
overflow-y: auto;
}

.modal-header {
padding: 20px;
border-bottom: 2px solid rgba(59, 130, 246, 0.3);
display: flex;
align-items: center;
justify-content: space-between;
}

.modal-title {
font-size: 22px;
font-weight: 800;
color: #3b82f6;
}

.modal-close {
background: none;
border: none;
color: #9ca3af;
font-size: 32px;
cursor: pointer;
line-height: 1;
transition: color 0.2s;
}

.modal-close:hover {
color: #ef4444;
}

.modal-body {
padding: 20px;
}

.modal-operators-list {
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 16px;
}

.modal-operator-item {
display: flex;
gap: 10px;
align-items: center;
}

.modal-operator-input {
flex: 1;
border-radius: 10px;
border: 2px solid rgba(59, 130, 246, 0.3);
background: #1e293b;
color: white;
padding: 12px 16px;
font-size: 15px;
font-weight: 600;
}

.modal-operator-input:focus {
outline: none;
border-color: #3b82f6;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.modal-footer {
padding: 20px;
border-top: 2px solid rgba(59, 130, 246, 0.3);
}

.btn-full {
width: 100%;
border-radius: 12px;
padding: 14px;
border: none;
font-weight: 800;
font-size: 16px;
background: #22c55e;
color: white;
cursor: pointer;
transition: all 0.2s;
}

.btn-full:hover {
background: #16a34a;
transform: translateY(-2px);
}

/* SCREENSHOT VIEW */
.hidden {
display: none !important;
}

.screenshot-view {
min-height: 100vh;
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
padding: 0;
}

.screenshot-container {
max-width: 100%;
margin: 0 auto;
}

.screenshot-header {
background: linear-gradient(90deg, #2563eb, #4f46e5);
color: white;
padding: 20px;
text-align: center;
}

.screenshot-title {
font-weight: 800;
font-size: 24px;
margin-bottom: 8px;
}

.screenshot-mode {
font-size: 16px;
opacity: 0.9;
margin-bottom: 4px;
}

.screenshot-date {
font-size: 14px;
opacity: 0.8;
}

.screenshot-kill-section {
background: linear-gradient(135deg, #dc2626, #991b1b);
color: white;
padding: 16px;
text-align: center;
}

.screenshot-reserves-section {
background: linear-gradient(135deg, #f59e0b, #d97706);
color: white;
padding: 16px;
text-align: center;
}

.section-screenshot-title {
font-weight: 800;
font-size: 16px;
margin-bottom: 8px;
}

.tags-container {
display: flex;
flex-wrap: wrap;
gap: 8px;
justify-content: center;
}

.tag {
background: rgba(255, 255, 255, 0.25);
border-radius: 20px;
padding: 6px 14px;
font-size: 13px;
font-weight: 700;
}

/* MAP SECTION */
.map-section {
background: rgba(15, 23, 42, 0.9);
padding: 0;
}

.map-container {
position: relative;
border-radius: 0;
height: 650px;
overflow: hidden;
box-shadow: none;
margin-bottom: 0;
}

.map-building {
position: absolute;
transform: translate(-50%, -50%);
}

.map-building-tile {
width: 70px;
height: 70px;
border-radius: 14px;
display: flex;
align-items: center;
justify-content: center;
border: 3px solid rgba(255, 255, 255, 0.8);
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
position: relative;
font-size: 32px;
}

.map-protected-badge {
position: absolute;
top: -8px;
left: -8px;
background: #fbbf24;
border-radius: 50%;
border: 2px solid white;
width: 26px;
height: 26px;
display: flex;
align-items: center;
justify-content: center;
font-size: 13px;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

.map-id-badge {
position: absolute;
top: -10px;
right: -10px;
background: #000000;
color: white;
font-weight: 900;
font-size: 14px;
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
border: 2px solid #4ade80;
}

.map-operators {
position: absolute;
display: flex;
flex-direction: column;
gap: 3px;
min-width: 80px;
}

.map-operators.left-column {
left: 100%;
top: 0;
margin-left: 10px;
align-items: flex-start;
}

.map-operators.right-column {
right: 100%;
top: 0;
margin-right: 10px;
align-items: flex-end;
}

.map-operators.center-column {
top: 100%;
left: 50%;
transform: translateX(-50%);
margin-top: 8px;
align-items: center;
}

.map-operators.center-column-top {
bottom: 100%;
left: 50%;
transform: translateX(-50%);
margin-bottom: 8px;
top: auto;
align-items: center;
}

.map-operator-name {
background: rgba(0, 0, 0, 0.9);
color: white;
padding: 3px 10px;
border-radius: 10px;
font-size: 10px;
font-weight: 800;
white-space: nowrap;
text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
}

/* STRATEGY TEXT */
.strategy-section {
background: rgba(15, 23, 42, 0.9);
border-radius: 16px;
padding: 20px;
margin: 20px;
border: 2px solid rgba(34, 197, 94, 0.3);
}

.strategy-header {
display: flex;
align-items: center;
justify-content: space-between;
flex-wrap: wrap;
gap: 12px;
margin-bottom: 16px;
}

.strategy-title {
font-weight: 800;
font-size: 18px;
color: #22c55e;
}

.btn-copy {
background: #22c55e;
color: white;
border: none;
border-radius: 10px;
padding: 10px 20px;
font-weight: 700;
font-size: 14px;
cursor: pointer;
transition: all 0.2s;
}

.btn-copy:hover {
background: #16a34a;
transform: translateY(-2px);
}

.strategy-text-wrapper {
background: rgba(0, 0, 0, 0.6);
border-radius: 12px;
padding: 16px;
max-height: 400px;
overflow-y: auto;
border: 1px solid rgba(34, 197, 94, 0.3);
}

.strategy-text {
font-family: ‚ÄòCourier New‚Äô, monospace;
font-size: 12px;
color: #4ade80;
white-space: pre-wrap;
line-height: 1.6;
}

.strategy-hint {
margin-top: 12px;
text-align: center;
font-size: 13px;
color: #9ca3af;
}

/* RESPONSIVE */
@media (max-width: 768px) {
.header-title {
font-size: 20px;
}

.buildings-grid {
grid-template-columns: 1fr;
}

.map-container {
height: 450px;
}

/* ‚úÖ CANYON BUILDINGS - Pi√π grandi e spaziati per mobile */
body.mode-canyon .map-building-tile {
width: 65px;
height: 65px;
font-size: 30px;
}

/* ‚úÖ DESERT BUILDINGS - Dimensione normale */
body.mode-desert .map-building-tile {
width: 55px;
height: 55px;
font-size: 26px;
}

.map-operator-name {
font-size: 9px;
padding: 2px 8px;
}

.map-operators {
min-width: 60px;
}
}

/* ‚úÖ ATTENDANCE PANEL - CHECK */
.attendance-panel {
background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
border: 2px solid rgba(34, 197, 94, 0.3);
border-radius: 16px;
padding: 24px;
margin: 30px 20px 40px 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.attendance-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 16px;
}

.attendance-title {
font-size: 22px;
font-weight: 800;
color: #22c55e;
display: flex;
align-items: center;
gap: 10px;
}

/* VINTAGE SWITCH */
.vintage-switch-container {
display: flex;
align-items: center;
gap: 12px;
}

.vintage-switch-label {
font-size: 14px;
font-weight: 600;
color: #9ca3af;
}

.vintage-switch {
position: relative;
width: 120px;
height: 50px;
background: #2c2c2c;
border-radius: 25px;
border: 3px solid #666;
box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
cursor: pointer;
overflow: hidden;
}

.vintage-switch input {
display: none;
}

.vintage-switch-track {
display: flex;
width: 100%;
height: 100%;
position: relative;
}

.vintage-switch-track::before {
content: ‚Äò‚Äô;
position: absolute;
width: 50px;
height: 44px;
background: linear-gradient(180deg, #ff4444, #cc0000);
border-radius: 22px;
top: 3px;
left: 3px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 2px rgba(255, 68, 68, 0.3);
z-index: 2;
}

.vintage-switch input:checked + .vintage-switch-track::before {
left: 64px;
background: linear-gradient(180deg, #44ff44, #00cc00);
box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 2px rgba(68, 255, 68, 0.3);
}

.team-label {
position: absolute;
top: 50%;
transform: translateY(-50%);
font-weight: bold;
font-size: 20px;
color: white;
z-index: 1;
text-shadow: 0 2px 4px rgba(0,0,0,0.5);
pointer-events: none;
}

.team-label.team-a {
left: 18px;
}

.team-label.team-b {
right: 18px;
}

/* ATTENDANCE BUTTONS */
.attendance-buttons {
display: flex;
gap: 12px;
flex-wrap: wrap;
}

.btn-attendance-action {
padding: 12px 24px;
border: none;
border-radius: 10px;
font-weight: 700;
font-size: 14px;
cursor: pointer;
transition: all 0.2s;
display: flex;
align-items: center;
gap: 8px;
}

.btn-load-formation {
background: linear-gradient(135deg, #3b82f6, #2563eb);
color: white;
}

.btn-load-formation:hover {
background: linear-gradient(135deg, #2563eb, #1d4ed8);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

.btn-save-attendance {
background: linear-gradient(135deg, #22c55e, #16a34a);
color: white;
}

.btn-save-attendance:hover {
background: linear-gradient(135deg, #16a34a, #15803d);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
}

.btn-attendance-action:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none !important;
}

/* ATTENDANCE TABLE */
.attendance-table-wrapper {
margin-top: 20px;
overflow-x: auto;
border-radius: 12px;
background: rgba(0, 0, 0, 0.3);
}

.attendance-table {
width: 100%;
border-collapse: collapse;
min-width: 600px;
}

.attendance-table thead {
background: linear-gradient(135deg, #1e293b, #334155);
}

.attendance-table th {
padding: 16px;
text-align: left;
font-weight: 700;
font-size: 14px;
color: #22c55e;
border-bottom: 2px solid rgba(34, 197, 94, 0.3);
}

.attendance-table tbody tr {
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
transition: all 0.2s;
}

.attendance-table tbody tr:hover {
background: rgba(34, 197, 94, 0.1);
}

.attendance-table td {
padding: 14px 16px;
font-size: 14px;
color: #e5e7eb;
}

.player-name-cell {
font-weight: 600;
color: #60a5fa;
}

.building-name-cell {
color: #fbbf24;
font-size: 13px;
}

/* ATTENDANCE CHECKBOX BUTTONS */
.attendance-checkbox-group {
display: flex;
gap: 8px;
}

.btn-attendance-check {
width: 40px;
height: 40px;
border: 2px solid transparent;
border-radius: 8px;
font-size: 20px;
cursor: pointer;
transition: all 0.2s;
background: rgba(255, 255, 255, 0.05);
display: flex;
align-items: center;
justify-content: center;
}

.btn-attendance-check:hover {
transform: scale(1.1);
}

.btn-attendance-check.yes {
border-color: rgba(34, 197, 94, 0.3);
}

.btn-attendance-check.yes:hover {
background: rgba(34, 197, 94, 0.2);
border-color: #22c55e;
}

.btn-attendance-check.yes.active {
background: linear-gradient(135deg, #22c55e, #16a34a);
border-color: #22c55e;
box-shadow: 0 0 16px rgba(34, 197, 94, 0.5);
}

.btn-attendance-check.no {
border-color: rgba(239, 68, 68, 0.3);
}

.btn-attendance-check.no:hover {
background: rgba(239, 68, 68, 0.2);
border-color: #ef4444;
}

.btn-attendance-check.no.active {
background: linear-gradient(135deg, #ef4444, #dc2626);
border-color: #ef4444;
box-shadow: 0 0 16px rgba(239, 68, 68, 0.5);
}

.attendance-empty-state {
text-align: center;
padding: 40px 20px;
color: #9ca3af;
}

.attendance-empty-state h3 {
font-size: 18px;
margin-bottom: 12px;
color: #60a5fa;
}

.attendance-empty-state p {
font-size: 14px;
line-height: 1.6;
}

@media (max-width: 768px) {
.attendance-header {
flex-direction: column;
align-items: stretch;
}

.attendance-buttons {
width: 100%;
}

.btn-attendance-action {
flex: 1;
}

.attendance-table {
font-size: 12px;
}

.attendance-table th,
.attendance-table td {
padding: 10px;
}

.btn-attendance-check {
width: 35px;
height: 35px;
font-size: 18px;
}
}

  </style>
</head>
<body>
<div class="app-container">
  <!-- HEADER -->
  <div class="header">
    <div class="header-title" id="headerTitle">üéØ Alliance Strategy Manager</div>
    <div class="header-subtitle" id="headerSubtitle">Tactical Coordination System</div>

<!-- MODE & LANGUAGE SWITCHER -->

<div class="switcher-container">
  <div class="mode-switcher">
    <button class="mode-btn active" data-mode="canyon">üèîÔ∏è Canyon</button>
    <button class="mode-btn" data-mode="desert">üèúÔ∏è Desert</button>
  </div>
  <div class="language-switcher">
    <button class="lang-btn active" data-lang="en">üá¨üáß EN</button>
    <button class="lang-btn" data-lang="it">üáÆüáπ IT</button>
    <button class="lang-btn" data-lang="fr">üá´üá∑ FR</button>
  </div>
  <!-- ‚úÖ TEAM SELECTOR -->
  <div class="team-selector">
    <button class="team-btn active" data-team="A">üÖ∞Ô∏è Team A</button>
    <button class="team-btn" data-team="B">üÖ±Ô∏è Team B</button>
  </div>
</div>

<div class="header-buttons">
  <button id="btnLoadDb" class="btn btn-warning">üìä <span id="loadDbText">Load from Sheets</span></button>
  <button id="btnSaveStrategy" class="btn btn-success">üíæ <span id="btnSaveText">Save Strategy</span></button>
  <button id="btnScreenshot" class="btn btn-primary">üì∏ <span id="btnPreviewText">Preview</span></button>
  <button id="btnCopyMain" class="btn btn-success">üìã <span id="btnCopyStrategyText">Copy Strategy</span></button>
</div>

  </div>

  <!-- EDIT VIEW -->

  <div id="editView" class="main-content">
    <!-- KILL SWAT SECTION -->
    <div class="section kill-swat-section">
      <div class="section-title" id="killSwatTitle">‚ö° KILL SWAT - Mobile Strike Unit</div>
      <div id="killSwatList" class="operators-list"></div>
      <button id="btnAddKillSwat" class="btn-add">
        <span style="font-size: 20px;">+</span> <span id="addOperatorText">Add Operator</span>
      </button>
    </div>

<!-- RESERVES SECTION -->

<div class="section reserves-section">
  <div class="section-title" id="reservesTitle">üü® RESERVES - Backup Operators</div>
  <div class="reserves-info" id="reservesInfo">
    Reserves are ready to replace main operators when needed. Max 10 reserves.
  </div>
  <div id="reservesList" class="operators-list"></div>
  <button id="btnAddReserve" class="btn-add">
    <span style="font-size: 20px;">+</span> <span id="addReserveText">Add Reserve</span>
  </button>
</div>

<!-- BUILDINGS SECTION -->

<div class="section">
  <div class="section-title" id="buildingsTitle">üè¢ Building Assignments</div>
  <div id="buildingsGrid" class="buildings-grid"></div>
</div>

<!-- ‚úÖ ATTENDANCE PANEL - CHECK -->

<div class="attendance-panel">
  <div class="attendance-header">
    <div class="attendance-title">
      <span>üìã</span>
      <span id="attendanceTitle">Last Formation Check</span>
    </div>

```
<!-- VINTAGE SWITCH -->
<div class="vintage-switch-container">
  <span class="vintage-switch-label">Select Team:</span>
  <div class="vintage-switch">
    <input type="checkbox" id="attendanceTeamSwitch">
    <label for="attendanceTeamSwitch" class="vintage-switch-track">
      <span class="team-label team-a">A</span>
      <span class="team-label team-b">B</span>
    </label>
  </div>
</div>

<!-- BUTTONS -->
<div class="attendance-buttons">
  <button id="btnLoadFormation" class="btn-attendance-action btn-load-formation">
    üì• <span>Load Formation</span>
  </button>
  <button id="btnSaveAttendance" class="btn-attendance-action btn-save-attendance" disabled>
    üíæ <span>Save Attendance</span>
  </button>
</div>
```

  </div>

  <!-- TABLE -->

  <div class="attendance-table-wrapper">
    <table class="attendance-table" id="attendanceTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Building</th>
          <th>Attended ‚úÖ</th>
          <th>Absent ‚õî</th>
        </tr>
      </thead>
      <tbody id="attendanceTableBody">
        <!-- Dynamic rows -->
      </tbody>
    </table>

```
<!-- EMPTY STATE -->
<div class="attendance-empty-state" id="attendanceEmptyState">
  <h3>No Formation Loaded</h3>
  <p>Select a team (A or B) and click "Load Formation" to see the last saved formation.</p>
</div>
```

  </div>
</div>

  </div>

  <!-- MODAL -->

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="modal-title">Building</div>
        <button id="modalClose" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalOperatorsList" class="modal-operators-list"></div>
        <button id="btnAddModalOperator" class="btn-add">
          <span style="font-size: 20px;">+</span> <span id="addModalOperatorText">Add Operator</span>
        </button>
      </div>
      <div class="modal-footer">
        <button id="modalSave" class="btn-full" id="modalSaveText">‚úì Save Assignments</button>
      </div>
    </div>
  </div>

  <!-- SCREENSHOT VIEW -->

  <div id="screenshotView" class="screenshot-view hidden">
    <div class="screenshot-container">
      <div id="screenshotCapture">
        <!-- Header -->
        <div class="screenshot-header">
          <div class="screenshot-title" id="screenshotAllianceName">Alliance Name</div>
          <div class="screenshot-mode" id="screenshotModeName">Canyon Mode</div>
          <div class="screenshot-date" id="screenshotDate"></div>
        </div>

```
<!-- Kill Swat -->
<div id="screenshotKillSection" class="screenshot-kill-section" style="display: none;">
  <div class="section-screenshot-title" id="screenshotKillTitle">‚ö° KILL SWAT</div>
  <div id="killTags" class="tags-container"></div>
</div>

<!-- Reserves -->
<div id="screenshotReservesSection" class="screenshot-reserves-section" style="display: none;">
  <div class="section-screenshot-title" id="screenshotReservesTitle">üü® RESERVES</div>
  <div id="reservesTags" class="tags-container"></div>
</div>

<!-- Map -->
<div class="map-section">
  <div id="mapContainer" class="map-container"></div>
</div>
```

  </div>

  <!-- Strategy Text -->

  <div class="strategy-section">
    <div class="strategy-header">
      <div class="strategy-title" id="strategyTextTitle">üìã Full Strategy Text</div>
      <button id="btnCopyScreenshot" class="btn-copy">üìã <span id="btnCopyText">Copy Text</span></button>
    </div>
    <div class="strategy-text-wrapper">
      <pre id="strategyText" class="strategy-text"></pre>
    </div>
    <div class="strategy-hint" id="strategyHint">
      üí° Copy the text and share it in alliance chat
    </div>
  </div>

  <!-- Back Button -->

  <div style="margin-top: 20px; text-align: center; padding: 0 20px 20px;">
    <button id="btnBack" class="btn btn-primary" style="padding: 14px 32px; font-size: 16px;">
      ‚Üê <span id="btnBackText">Back to Edit</span>
    </button>
  </div>
</div>

  </div>
</div>

<script>
// ===== CONFIGURATION =====
// ‚úÖ URL AGGIORNATO con il nuovo deployment (Versione 8)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxW7r1urLCNeU3XfR_2hZ2J4nXipgrM1i7bsMlSxuUC1Dpu0h8BRXlhsZggLG-ecvm24Q/exec";

// ‚úÖ COMANDI TATTICI (con prefisso per riconoscerli)
const TACTICAL_COMMANDS = [
  '[KILL SWAT]',
  '[HOLD POSITION]',
  '[SPLIT UP]',
  '[HELP REFINERY]',
  '[HELP HOSPITAL]',
  '[HELP INFO CENTER]',
  '[IF START LEFT]',
  '[IF START RIGHT]',
  '[PLAN A]',
  '[PLAN B]'
];

// üîç DIAGNOSTICA ATTIVA - Mostra errori dettagliati
const DEBUG_MODE = true;

function debugLog(message, data = null) {
  if (DEBUG_MODE) {
    console.log('üîç DEBUG:', message, data || '');
    if (data && data.error) {
      console.error('‚ùå ERROR:', data.error);
    }
  }
}

// ===== GLOBAL PLAYERS LIST =====
let availablePlayers = []; // Lista giocatori da Google Sheets

// ‚úÖ HELPER FUNCTIONS PER MOSTRARE T1 CON EMOJI
function getT1Info(player) {
  if (!player.missiles && !player.aircraft && !player.tanks) {
    return null;
  }
  
  const max = Math.max(player.missiles || 0, player.aircraft || 0, player.tanks || 0);
  
  if (player.missiles === max) {
    return { type: 'missiles', value: player.missiles, emoji: 'üöÄ' };
  }
  if (player.aircraft === max) {
    return { type: 'aircraft', value: player.aircraft, emoji: '‚úàÔ∏è' };
  }
  if (player.tanks === max) {
    return { type: 'tanks', value: player.tanks, emoji: 'üõ°Ô∏è' };
  }
  
  return null;
}

function formatNumber(num) {
  if (!num || num === 0) return '0';
  
  // ‚úÖ REGOLA FISSA: SEMPRE formato XX.XM (mai K, sempre M)
  
  // Determina il divisore giusto per avere sempre 2 cifre prima del punto
  let value;
  
  if (num >= 100000000) {
    // >= 100M ‚Üí divide per 1M per avere XX.XM
    value = num / 1000000;
  } else if (num >= 10000000) {
    // >= 10M ‚Üí divide per 100K per avere XX.XM
    value = num / 100000;
  } else if (num >= 1000000) {
    // >= 1M ‚Üí divide per 100K per avere XX.XM  
    value = num / 100000;
  } else if (num >= 100000) {
    // >= 100K ‚Üí divide per 10K per avere XX.XM
    value = num / 10000;
  } else if (num >= 10000) {
    // >= 10K ‚Üí divide per 1K per avere XX.XM
    value = num / 1000;
  } else if (num >= 1000) {
    // >= 1K ‚Üí divide per 100 per avere XX.XM
    value = num / 100;
  } else if (num >= 100) {
    // >= 100 ‚Üí divide per 10 per avere XX.XM
    value = num / 10;
  } else if (num >= 10) {
    // >= 10 ‚Üí divide per 1 per avere XX.XM
    value = num / 1;
  } else {
    // < 10 ‚Üí mostra come X.XM
    value = num;
  }
  
  // Arrotonda a 1 decimale e aggiungi SEMPRE M
  return value.toFixed(1) + 'M';
}

function formatPlayerOption(player) {
  const t1 = getT1Info(player);
  if (t1) {
    return `${player.name} ${t1.emoji} ${formatNumber(t1.value)}`;
  }
  return player.name;
}
let isLoadingPlayers = false;

// ===== TRANSLATIONS =====
const translations = {
  en: {
    title: "Alliance Strategy Manager",
    subtitle: "Tactical Coordination System",
    loadDb: "Load from Sheets",
    preview: "Preview",
    copyStrategy: "Copy Strategy",
    saveStrategy: "Save Strategy",
    saving: "Saving...",
    strategyDaved: "Strategy Saved!",
    killSwat: "KILL SWAT - Mobile Strike Unit",
    reserves: "RESERVES - Backup Operators",
    reservesInfo: "Reserves are ready to replace main operators when needed. Max 10 reserves.",
    buildings: "Building Assignments",
    addOperator: "Add Operator",
    addReserve: "Add Reserve",
    saveAssignments: "Save Assignments",
    backToEdit: "Back to Edit",
    copyText: "Copy Text",
    strategyTitle: "Full Strategy Text",
    strategyHint: "Copy the text and share it in alliance chat",
    noOperators: "No operators assigned",
    operator: "Operator",
    building: "Building",
    canyon: "Canyon",
    desert: "Desert",
    canyonMode: "Canyon Mode",
    desertMode: "Desert Mode",
    saved: "Saved!",
    loaded: "Loaded!",
    copied: "Copied!",
    error: "Error"
  },
  it: {
    title: "Gestore Strategia Alleanza",
    subtitle: "Sistema di Coordinamento Tattico",
    loadDb: "Carica da Sheets",
    preview: "Anteprima",
    copyStrategy: "Copia Strategia",
    saveStrategy: "Salva Strategia",
    saving: "Salvataggio...",
    strategySaved: "Strategia Salvata!",
    killSwat: "KILL SWAT - Unit√† Mobile d'Attacco",
    reserves: "RISERVE - Operatori di Backup",
    reservesInfo: "Le riserve sono pronte a sostituire gli operatori principali quando necessario. Max 10 riserve.",
    buildings: "Assegnazione Edifici",
    addOperator: "Aggiungi Operatore",
    addReserve: "Aggiungi Riserva",
    saveAssignments: "Salva Assegnazioni",
    backToEdit: "Torna alla Modifica",
    copyText: "Copia Testo",
    strategyTitle: "Testo Strategia Completa",
    strategyHint: "Copia il testo e condividilo nella chat dell'alleanza",
    noOperators: "Nessun operatore assegnato",
    operator: "Operatore",
    building: "Edificio",
    canyon: "Canyon",
    desert: "Desert",
    canyonMode: "Modalit√† Canyon",
    desertMode: "Modalit√† Desert",
    saved: "Salvato!",
    loaded: "Caricato!",
    copied: "Copiato!",
    error: "Errore"
  },
  fr: {
    title: "Gestionnaire de Strat√©gie d'Alliance",
    subtitle: "Syst√®me de Coordination Tactique",
    loadDb: "Charger de Sheets",
    preview: "Aper√ßu",
    copyStrategy: "Copier Strat√©gie",
    saveStrategy: "Sauvegarder Strat√©gie",
    saving: "Sauvegarde...",
    strategySaved: "Strat√©gie Sauvegard√©e!",
    killSwat: "KILL SWAT - Unit√© Mobile d'Attaque",
    reserves: "R√âSERVES - Op√©rateurs de Backup",
    reservesInfo: "Les r√©serves sont pr√™tes √† remplacer les op√©rateurs principaux si n√©cessaire. Max 10 r√©serves.",
    buildings: "Affectation des B√¢timents",
    addOperator: "Ajouter Op√©rateur",
    addReserve: "Ajouter R√©serve",
    saveAssignments: "Sauvegarder Affectations",
    backToEdit: "Retour √† l'√âdition",
    copyText: "Copier Texte",
    strategyTitle: "Texte Complet de la Strat√©gie",
    strategyHint: "Copiez le texte et partagez-le dans le chat de l'alliance",
    noOperators: "Aucun op√©rateur assign√©",
    operator: "Op√©rateur",
    building: "B√¢timent",
    canyon: "Canyon",
    desert: "D√©sert",
    canyonMode: "Mode Canyon",
    desertMode: "Mode D√©sert",
    saved: "Sauvegard√©!",
    loaded: "Charg√©!",
    copied: "Copi√©!",
    error: "Erreur"
  }
};

// ===== MODE CONFIGURATIONS =====
const modeConfigs = {
  canyon: {
    mapColor: "linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%)",
    buildings: [
      { id: 1, x: 20, y: 15, rate: 25, type: { en: "Data Center", it: "Data Center", fr: "Centre de Donn√©es" }, icon: "üíæ", color: "#3b82f6" },
      { id: 2, x: 80, y: 15, rate: 25, type: { en: "Data Center", it: "Data Center", fr: "Centre de Donn√©es" }, icon: "üíæ", color: "#3b82f6" },
      { id: 3, x: 20, y: 32, rate: 20, type: { en: "Serum Factory", it: "Fabbrica Sieri", fr: "Usine de S√©rum" }, icon: "üß¨", color: "#8b5cf6" },
      { id: 4, x: 50, y: 32, rate: 40, type: { en: "Power Tower", it: "Torre Energia", fr: "Tour d'√ânergie" }, icon: "‚ö°", color: "#f59e0b" },
      { id: 5, x: 80, y: 32, rate: 20, type: { en: "Defense System", it: "Sistema Difesa", fr: "Syst√®me D√©fense" }, icon: "üõ°Ô∏è", color: "#ef4444" },
      { id: 6, x: 20, y: 49, rate: 20, type: { en: "Defense System", it: "Sistema Difesa", fr: "Syst√®me D√©fense" }, icon: "üõ°Ô∏è", color: "#ef4444" },
      { id: 7, x: 50, y: 49, rate: 100, protected: true, type: { en: "Virus Lab", it: "Laboratorio Virus", fr: "Labo Virus" }, icon: "‚ò£Ô∏è", color: "#22c55e" },
      { id: 8, x: 80, y: 49, rate: 20, type: { en: "Serum Factory", it: "Fabbrica Sieri", fr: "Usine de S√©rum" }, icon: "üß¨", color: "#8b5cf6" },
      { id: 9, x: 20, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 10, x: 40, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 11, x: 60, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" },
      { id: 12, x: 80, y: 70, rate: 20, type: { en: "Sample Warehouse", it: "Magazzino", fr: "Entrep√¥t" }, icon: "üì¶", color: "#64748b" }
    ]
  },
  desert: {
    mapColor: "linear-gradient(135deg, #d97706, #b45309)",
    buildings: [
      { id: 1, x: 90, y: 15, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 2, x: 90, y: 32, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 3, x: 10, y: 78, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 4, x: 10, y: 55, rate: 30, type: { en: "Hospital", it: "Ospedale", fr: "H√¥pital" }, icon: "üè•", color: "#ef4444" },
      { id: 5, x: 10, y: 32, rate: 50, type: { en: "Refinery", it: "Raffineria", fr: "Raffinerie" }, icon: "‚öôÔ∏è", color: "#64748b" },
      { id: 6, x: 90, y: 78, rate: 10, type: { en: "Info Center", it: "Centro Info", fr: "Centre Info" }, icon: "‚ÑπÔ∏è", color: "#3b82f6" },
      { id: 7, x: 10, y: 15, rate: 10, type: { en: "Tech Center", it: "Centro Tech", fr: "Centre Tech" }, icon: "üì°", color: "#8b5cf6" },
      { id: 8, x: 90, y: 55, rate: 50, type: { en: "Refinery", it: "Raffineria", fr: "Raffinerie" }, icon: "‚öôÔ∏è", color: "#64748b" },
      { id: 9, x: 50, y: 74, rate: 10, protected: true, type: { en: "Merc Factory", it: "Fabbrica", fr: "Usine Mercs" }, icon: "üè≠", color: "#f59e0b" },
      { id: 10, x: 50, y: 22, rate: 10, protected: true, type: { en: "Arsenal", it: "Arsenale", fr: "Arsenal" }, icon: "üî´", color: "#475569" },
      { id: 11, x: 50, y: 48, rate: 80, protected: true, type: { en: "Nuclear Silo", it: "Silo Nucleare", fr: "Silo Nucl√©aire" }, icon: "‚ò¢Ô∏è", color: "#22c55e" }
    ]
  }
};

// ===== STATE =====
let currentMode = 'canyon';
let currentLang = 'en';
let currentTeam = 'A'; // ‚úÖ Team A or B

// ‚úÖ ATTENDANCE SYSTEM
let attendanceTeam = 'A'; // Team for attendance check (separate from strategy team)
let lastFormationData = []; // Loaded formation
let attendanceData = {}; // {playerName: 'YES' or 'NO'}
let players = {};
let allianceConfig = {
  alliance_name: "NGC",
  alliance_color: "#4a6b47",
  alliance_logo: "üéØ",
  tagline: "Tactical Warfare Division"
};
let selectedBuildingId = null;

// ===== INIT =====
function init() {
  loadFromLocalStorage();
  loadAllianceConfig();
  setupEventListeners();
  setupAttendanceListeners(); // ‚úÖ ATTENDANCE SYSTEM
  updateUI();
}

// ===== STORAGE =====
function loadFromLocalStorage() {
  try {
    const savedMode = localStorage.getItem("allianceStrategyMode");
    if (savedMode) currentMode = savedMode;

    const savedLang = localStorage.getItem("allianceStrategyLang");
    if (savedLang) currentLang = savedLang;

    const canyonData = localStorage.getItem("canyonPlayers");
    const desertData = localStorage.getItem("desertPlayers");

    players.canyon = canyonData ? JSON.parse(canyonData) : initializePlayers('canyon');
    players.desert = desertData ? JSON.parse(desertData) : initializePlayers('desert');
    
    // ‚úÖ CARICA I GIOCATORI DALLA CACHE LOCALE!
    const cachedPlayers = localStorage.getItem('alliance_players_cache');
    if (cachedPlayers) {
      availablePlayers = JSON.parse(cachedPlayers);
      console.log('‚úÖ Loaded', availablePlayers.length, 'players from cache');
      
      const lastUpdate = localStorage.getItem('alliance_players_last_update');
      if (lastUpdate) {
        const lastDate = new Date(lastUpdate);
        console.log('üìÖ Last sync:', lastDate.toLocaleString());
      }
    } else {
      console.log('‚ö†Ô∏è No cached players - click "Load from Sheets" to sync');
    }
  } catch (e) {
    console.error("Error loading from localStorage:", e);
    players.canyon = initializePlayers('canyon');
    players.desert = initializePlayers('desert');
    availablePlayers = [];
  }
}

function initializePlayers(mode) {
  const data = { killSwat: [], reserves: [] };
  modeConfigs[mode].buildings.forEach(b => {
    data[b.id] = [];
  });
  return data;
}

function saveToLocalStorage() {
  localStorage.setItem("allianceStrategyMode", currentMode);
  localStorage.setItem("allianceStrategyLang", currentLang);
  localStorage.setItem("canyonPlayers", JSON.stringify(players.canyon));
  localStorage.setItem("desertPlayers", JSON.stringify(players.desert));
}

// ===== ALLIANCE CONFIG =====
async function loadAllianceConfig() {
  if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
    return;
  }

  try {
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getConfig`);
    const result = await response.json();
    if (result.status === 'success') {
      const config = result.data;
      allianceConfig = {
        alliance_name: config.alliance_name || 'NGC',
        alliance_logo: config.logo_url ? `<img src="${config.logo_url}" style="height:24px">` : 'üéØ',
        alliance_color: config.primary_color || '#4a6b47',
        tagline: config.announcement || 'Tactical Warfare Division'
      };
      updateUI();
    }
  } catch (e) {
    console.error("Error loading alliance config:", e);
  }
}

// ===== LOAD PLAYERS FROM GOOGLE SHEETS =====
async function loadPlayersFromSheets() {
  if (isLoadingPlayers) {
    console.warn('‚ö†Ô∏è Already loading, please wait...');
    return;
  }
  
  isLoadingPlayers = true;
  const btnLoadDb = document.getElementById('btnLoadDb');
  const originalHTML = btnLoadDb.innerHTML;
  
  try {
    btnLoadDb.disabled = true;
    btnLoadDb.innerHTML = '‚è≥ <span>Loading...</span>';
    
    console.log('üöÄ ========== LOAD PLAYERS FROM SHEETS ==========');
    console.log('üì° Google Script URL:', GOOGLE_SCRIPT_URL);
    
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
      throw new Error('‚ùå Google Script URL not configured!');
    }
    
    // ‚úÖ USA getLatestPlayers per avere anche le potenze!
    const url = `${GOOGLE_SCRIPT_URL}?action=getLatestPlayers`;
    console.log('üîó Full URL:', url);
    console.log('üì§ Sending GET request...');
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    console.log('üì• Response status:', response.status);
    console.log('üì• Response OK:', response.ok);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Response error:', errorText);
      throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
    }
    
    const responseText = await response.text();
    console.log('üìÑ Response text (first 500 chars):', responseText.substring(0, 500));
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (parseError) {
      console.error('‚ùå JSON Parse Error:', parseError);
      console.error('‚ùå Response was:', responseText);
      throw new Error('Invalid JSON response from server');
    }
    
    console.log('üìä Parsed result:', result);
    console.log('üìä Result status:', result.status);
    console.log('üìä Result data:', result.data);
    
    // ‚úÖ GESTIONE CORRETTA DEI DATI CON POTENZE
    if (result.status === 'success' && result.data && result.data.players) {
      // L'API restituisce { players: [{name, missiles, aircraft, tanks, total}, ...] }
      availablePlayers = result.data.players.map(p => ({
        name: p.name,
        missiles: p.missiles || 0,
        aircraft: p.aircraft || 0,
        tanks: p.tanks || 0,
        total: p.total || 0
      }));
      
      console.log(`‚úÖ SUCCESS! Loaded ${availablePlayers.length} players`);
      
      if (availablePlayers.length === 0) {
        console.warn('‚ö†Ô∏è No players in the list!');
        alert('‚ö†Ô∏è No players found!\n\nChecklist:\n‚úì Do you have data in "Latest Players" sheet?\n‚úì Try: Google Sheets ‚Üí Menu ‚Üí "üìä Aggiorna Statistiche"\n‚úì Check if data was added to War Room Data');
        btnLoadDb.innerHTML = originalHTML;
        btnLoadDb.disabled = false;
        isLoadingPlayers = false;
        return;
      }
      
      console.log('üë• First 5 players:', availablePlayers.slice(0, 5).map(p => p.name));
      
      // ‚úÖ SALVA NEL LOCALSTORAGE
      console.log('üíæ Saving to localStorage...');
      localStorage.setItem('alliance_players_cache', JSON.stringify(availablePlayers));
      localStorage.setItem('alliance_players_last_update', new Date().toISOString());
      console.log('‚úÖ Saved to localStorage');
      
      // ‚úÖ RI-RENDERIZZA LE LISTE
      console.log('üîÑ Re-rendering lists...');
      renderKillSwatList();
      renderReservesList();
      console.log('‚úÖ Lists rendered');
      
      // Aggiorna tutti i dropdown
      console.log('üîÑ Updating all dropdowns...');
      updateAllDropdowns();
      console.log('‚úÖ Dropdowns updated');
      
      // Feedback successo
      btnLoadDb.innerHTML = `‚úÖ ${availablePlayers.length} players loaded!`;
      btnLoadDb.style.background = '#22c55e';
      
      console.log('üéâ All done! Players ready to use.');
      console.log('================================================');
      
      setTimeout(() => {
        btnLoadDb.innerHTML = originalHTML;
        btnLoadDb.style.background = '';
        btnLoadDb.disabled = false;
      }, 2000);
      
    } else {
      console.error('‚ùå Invalid response structure:', result);
      let errorMsg = result.message || 'Unknown error';
      
      if (result.status === 'error') {
        errorMsg = `Server error: ${errorMsg}\n\nPossible causes:\n- Latest Players sheet is empty\n- getPlayerNames function error\n- Script not deployed correctly`;
      }
      
      throw new Error(errorMsg);
    }
    
  } catch (error) {
    console.error('‚ùå ========== ERROR ==========');
    console.error('‚ùå Error type:', error.name);
    console.error('‚ùå Error message:', error.message);
    console.error('‚ùå Error stack:', error.stack);
    console.error('================================');
    
    let userMessage = '‚ùå Failed to load players\n\n';
    userMessage += 'üìã Error: ' + error.message + '\n\n';
    userMessage += 'üîç Checklist:\n';
    userMessage += '‚úì URL ends with /exec (not /dev)?\n';
    userMessage += '‚úì Script deployed as "Web app"?\n';
    userMessage += '‚úì "Who has access" = "Anyone"?\n';
    userMessage += '‚úì Latest Players sheet has data?\n';
    userMessage += '‚úì Ran "Aggiorna Statistiche" in Sheets?\n\n';
    userMessage += 'üí° Press F12 ‚Üí Console for details';
    
    alert(userMessage);
    btnLoadDb.innerHTML = originalHTML;
    btnLoadDb.disabled = false;
  } finally {
    isLoadingPlayers = false;
  }
}

// ===== UPDATE ALL DROPDOWNS WITH PLAYERS =====
function updateAllDropdowns() {
  const killSwatSelects = document.querySelectorAll('#killSwatList select');
  killSwatSelects.forEach(select => populatePlayerSelect(select));
  
  const reserveSelects = document.querySelectorAll('#reservesList select');
  reserveSelects.forEach(select => populatePlayerSelect(select));
  
  const modalSelects = document.querySelectorAll('#modalOperatorsList select');
  modalSelects.forEach(select => populatePlayerSelect(select));
}

// ===== POPULATE SELECT WITH PLAYERS =====
function populatePlayerSelect(select) {
  if (!select) return;
  
  const currentValue = select.value;
  select.innerHTML = '';
  
  // Opzione vuota
  const emptyOption = document.createElement('option');
  emptyOption.value = '';
  emptyOption.textContent = '--- Select Player ---';
  select.appendChild(emptyOption);
  
  // ‚úÖ Aggiungi comandi tattici PRIMA dei giocatori
  TACTICAL_COMMANDS.forEach(command => {
    const option = document.createElement('option');
    option.value = command;
    option.textContent = command;
    option.className = 'tactical-command';
    option.style.color = '#ff9800';
    option.style.fontWeight = 'bold';
    option.style.fontStyle = 'italic';
    select.appendChild(option);
  });
  
  // Aggiungi tutti i giocatori
  availablePlayers.forEach(player => {
    const option = document.createElement('option');
    option.value = player.name;
    // ‚úÖ MOSTRA T1 CON EMOJI: "Serafino üöÄ 43.44K"
    option.textContent = formatPlayerOption(player);
    select.appendChild(option);
  });
  
  // Ripristina valore precedente se esiste
  if (currentValue) {
    select.value = currentValue;
  }
}

// ===== CREATE PLAYER SELECT (instead of input) =====
function createPlayerSelect(placeholder = '', value = '') {
  const select = document.createElement('select');
  select.className = 'operator-input';
  select.style.cursor = 'pointer';
  
  // Opzione vuota
  const emptyOption = document.createElement('option');
  emptyOption.value = '';
  emptyOption.textContent = availablePlayers.length > 0 ? '--- Select Player ---' : placeholder;
  select.appendChild(emptyOption);
  
  // Aggiungi giocatori se caricati
  if (availablePlayers.length > 0) {
    // ‚úÖ Aggiungi comandi tattici PRIMA dei giocatori
    TACTICAL_COMMANDS.forEach(command => {
      const option = document.createElement('option');
      option.value = command;
      option.textContent = command;
      option.className = 'tactical-command';
      option.style.color = '#ff9800';
      option.style.fontWeight = 'bold';
      option.style.fontStyle = 'italic';
      select.appendChild(option);
    });
    
    availablePlayers.forEach(player => {
      const option = document.createElement('option');
      option.value = player.name;
      // ‚úÖ MOSTRA T1 CON EMOJI: "Serafino üöÄ 43.44K"
      option.textContent = formatPlayerOption(player);
      select.appendChild(option);
    });
  }
  
  // Imposta valore se fornito
  if (value) {
    select.value = value;
  }
  
  return select;
}

// ===== RESET CURRENT STRATEGY =====
function resetCurrentStrategy() {
  // Resetta killSwat
  players[currentMode].killSwat = [];
  
  // Resetta reserves
  players[currentMode].reserves = [];
  
  // Resetta tutti gli edifici
  const buildings = modeConfigs[currentMode].buildings;
  buildings.forEach(building => {
    players[currentMode][building.id] = [];
  });
  
  // Salva e aggiorna UI
  saveToLocalStorage();
  updateUI();
  renderKillSwatList();
  renderReservesList();
  renderBuildings();
}

// ===== SAVE STRATEGY TO GOOGLE SHEETS =====
async function saveStrategyToSheets() {
  const btn = document.getElementById('btnSaveStrategy');
  const originalHTML = btn.innerHTML;
  const t = translations[currentLang];
  
  try {
    btn.disabled = true;
    btn.innerHTML = `‚è≥ <span>${t.saving}</span>`;
    
    const killSwat = players[currentMode].killSwat.filter(p => p && p.trim() !== '');
    const reserves = players[currentMode].reserves.filter(p => p && p.trim() !== '');
    
    const buildingsData = [];
    const buildings = modeConfigs[currentMode].buildings;
    
    buildings.forEach(building => {
      const operators = players[currentMode][building.id] || [];
      operators.forEach(operator => {
        if (operator && operator.trim() !== '') {
          buildingsData.push({
            player: operator,
            building: building.type.en,
            team: currentTeam, // ‚úÖ USA IL TEAM SELEZIONATO
            killSwat: killSwat.includes(operator) ? 'YES' : 'NO',
            role: 'Main'
          });
        }
      });
    });
    
    killSwat.forEach(operator => {
      const alreadyAdded = buildingsData.find(b => b.player === operator);
      if (!alreadyAdded) {
        buildingsData.push({
          player: operator,
          building: '',
          team: currentTeam, // ‚úÖ USA IL TEAM SELEZIONATO
          killSwat: 'YES',
          role: 'Main'
        });
      }
    });
    
    reserves.forEach(operator => {
      buildingsData.push({
        player: operator,
        building: '',
        team: currentTeam, // ‚úÖ USA IL TEAM SELEZIONATO
        killSwat: 'NO',
        role: 'Reserve'
      });
    });
    
    console.log('üì§ Saving strategy:', buildingsData);
    
    // ‚úÖ FIXED: Salva direttamente in HISTORY (non in Manager)
    const action = currentMode === 'canyon' ? 'saveToCanyonHistory' : 'saveToStormHistory';
    
    // ‚úÖ Recupera codice R4 dal sessionStorage (impostato dall'index)
    const r4Code = sessionStorage.getItem('r4Code') || '';
    
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: action,
        data: buildingsData,
        r4Code: r4Code
      })
    });
    
    const result = await response.json();
    console.log('üì• Save response:', result);
    
    if (result.status === 'success') {
      btn.innerHTML = `‚úÖ <span>${t.strategySaved}</span>`;
      btn.style.background = '#22c55e';
      
      // ‚úÖ RESET AUTOMATICO dopo 2 secondi
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = '';
        btn.disabled = false;
        
        // ‚úÖ CANCELLA TUTTO per ricominciare
        resetCurrentStrategy();
        
        alert(`‚úÖ Strategy saved for Team ${currentTeam}!\nüîÑ Form reset. Ready for next team!`);
      }, 2000);
    } else {
      throw new Error(result.message || 'Failed to save strategy');
    }
    
  } catch (error) {
    console.error('‚ùå Error saving strategy:', error);
    alert(`‚ùå Error: ${error.message}`);
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
}

function showButtonFeedback(btnId, text) {
  const btn = document.getElementById(btnId);
  const originalHTML = btn.innerHTML;
  btn.innerHTML = `‚úÖ ${text}`;
  btn.style.background = "#16a34a";
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.style.background = "";
  }, 2000);
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  // Mode switcher
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.dataset.mode;
      saveToLocalStorage();
      updateUI();
    });
  });

  // Language switcher
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentLang = btn.dataset.lang;
      saveToLocalStorage();
      updateUI();
    });
  });

  // ‚úÖ Team selector
  document.querySelectorAll('.team-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTeam = btn.dataset.team;
      saveToLocalStorage();
      updateUI();
    });
  });

  // Buttons
  document.getElementById('btnLoadDb').addEventListener('click', loadPlayersFromSheets);
  document.getElementById('btnSaveStrategy').addEventListener('click', saveStrategyToSheets);
  document.getElementById('btnScreenshot').addEventListener('click', showScreenshotView);
  document.getElementById('btnCopyMain').addEventListener('click', () => copyStrategy('btnCopyMain'));
  document.getElementById('btnBack').addEventListener('click', showEditView);
  document.getElementById('btnCopyScreenshot').addEventListener('click', () => copyStrategy('btnCopyScreenshot'));

  // Kill Swat
  document.getElementById('btnAddKillSwat').addEventListener('click', () => {
    players[currentMode].killSwat.push("");
    saveToLocalStorage();
    renderKillSwatList();
  });

  // Reserves
  document.getElementById('btnAddReserve').addEventListener('click', () => {
    if (players[currentMode].reserves.length >= 10) {
      alert("Maximum 10 reserves!");
      return;
    }
    players[currentMode].reserves.push("");
    saveToLocalStorage();
    renderReservesList();
  });

  // Modal
  document.getElementById('btnAddModalOperator').addEventListener('click', () => {
    if (selectedBuildingId) {
      players[currentMode][selectedBuildingId].push("");
      renderModalOperatorsList();
    }
  });

  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('modalSave').addEventListener('click', saveModal);
  document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
  });
}

// ===== HELPER: TIME AGO =====
function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
  if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
  return Math.floor(seconds / 86400) + ' days ago';
}

// ===== UPDATE UI =====
function updateUI() {
  const t = translations[currentLang];
  
  // ‚úÖ ADD BODY CLASS FOR MODE-SPECIFIC STYLING
  document.body.className = `mode-${currentMode}`;

  document.getElementById('headerTitle').textContent = `${allianceConfig.alliance_logo} ${t.title}`;
  document.getElementById('headerSubtitle').textContent = allianceConfig.tagline;
  document.getElementById('loadDbText').textContent = t.loadDb;
  
  const btnLoadDb = document.getElementById('btnLoadDb');
  if (availablePlayers.length > 0) {
    const lastUpdate = localStorage.getItem('alliance_players_last_update');
    if (lastUpdate) {
      const date = new Date(lastUpdate);
      const timeAgo = getTimeAgo(date);
      btnLoadDb.title = `${availablePlayers.length} players cached (${timeAgo})`;
    }
  }
  
  document.getElementById('btnPreviewText').textContent = t.preview;
  document.getElementById('btnSaveText').textContent = t.saveStrategy;
  document.getElementById('btnCopyStrategyText').textContent = t.copyStrategy;
  document.getElementById('killSwatTitle').textContent = `‚ö° ${t.killSwat}`;
  document.getElementById('reservesTitle').textContent = `üü® ${t.reserves}`;
  document.getElementById('reservesInfo').textContent = t.reservesInfo;
  document.getElementById('buildingsTitle').textContent = `üè¢ ${t.buildings}`;
  document.getElementById('addOperatorText').textContent = t.addOperator;
  document.getElementById('addReserveText').textContent = t.addReserve;
  document.getElementById('addModalOperatorText').textContent = t.addOperator;
  document.getElementById('modalSave').textContent = `‚úì ${t.saveAssignments}`;
  document.getElementById('btnBackText').textContent = t.backToEdit;
  document.getElementById('btnCopyText').textContent = t.copyText;
  document.getElementById('strategyTextTitle').textContent = `üìã ${t.strategyTitle}`;
  document.getElementById('strategyHint').textContent = `üí° ${t.strategyHint}`;

  renderEditView();
}

// ===== RENDER FUNCTIONS =====
function renderKillSwatList() {
  const container = document.getElementById('killSwatList');
  const data = players[currentMode].killSwat;
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    data.push("");
  }

  data.forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'operator-item';

    const select = createPlayerSelect(`${t.operator} ${index + 1}`, name);
    select.addEventListener('change', (e) => {
      players[currentMode].killSwat[index] = e.target.value;
      saveToLocalStorage();
    });

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode].killSwat.splice(index, 1);
      saveToLocalStorage();
      renderKillSwatList();
    });

    item.appendChild(select);
    if (data.length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function renderReservesList() {
  const container = document.getElementById('reservesList');
  const data = players[currentMode].reserves;
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    data.push("");
  }

  data.forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'operator-item';

    const select = createPlayerSelect(`${t.operator} ${index + 1}`, name);
    select.addEventListener('change', (e) => {
      players[currentMode].reserves[index] = e.target.value;
      saveToLocalStorage();
    });

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode].reserves.splice(index, 1);
      saveToLocalStorage();
      renderReservesList();
    });

    item.appendChild(select);
    if (data.length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function renderEditView() {
  renderKillSwatList();
  renderReservesList();

  const grid = document.getElementById('buildingsGrid');
  const buildings = modeConfigs[currentMode].buildings;
  const t = translations[currentLang];

  grid.innerHTML = "";

  buildings.forEach(b => {
    const card = document.createElement('div');
    card.className = 'building-card';

    const header = document.createElement('div');
    header.className = 'building-header';

    const icon = document.createElement('div');
    icon.className = 'building-icon';
    icon.style.backgroundColor = b.color;
    icon.textContent = b.icon;

    if (b.protected) {
      const badge = document.createElement('div');
      badge.className = 'protected-badge';
      badge.textContent = 'üõ°Ô∏è';
      icon.appendChild(badge);
    }

    const info = document.createElement('div');
    info.className = 'building-info';
    info.innerHTML = `
      <div class="building-number">${t.building} ${b.id}</div>
      <div class="building-type">${b.type[currentLang]}</div>
      <div class="building-rate">+${b.rate}/s</div>
    `;

    header.appendChild(icon);
    header.appendChild(info);

    const playersList = document.createElement('div');
    playersList.className = 'players-list';

    const assigned = (players[currentMode][b.id] || []).filter(p => p && p.trim() !== "");
    if (assigned.length > 0) {
      assigned.forEach(p => {
        const tag = document.createElement('div');
        tag.className = 'player-tag';
        tag.textContent = 'üë§ ' + p;
        playersList.appendChild(tag);
      });
    } else {
      const noPlayers = document.createElement('div');
      noPlayers.className = 'no-players';
      noPlayers.textContent = t.noOperators;
      playersList.appendChild(noPlayers);
    }

    card.appendChild(header);
    card.appendChild(playersList);

    card.addEventListener('click', () => openModal(b.id));

    grid.appendChild(card);
  });
}

// ===== MODAL =====
function openModal(id) {
  selectedBuildingId = id;
  const buildings = modeConfigs[currentMode].buildings;
  const building = buildings.find(b => b.id === id);
  const t = translations[currentLang];

  document.getElementById('modalTitle').textContent = `${t.building} ${id} - ${building.type[currentLang]}`;

  renderModalOperatorsList();

  document.getElementById('modalOverlay').style.display = 'flex';
}

function renderModalOperatorsList() {
  const container = document.getElementById('modalOperatorsList');
  const data = players[currentMode][selectedBuildingId] || [];
  const t = translations[currentLang];

  container.innerHTML = "";

  if (data.length === 0) {
    players[currentMode][selectedBuildingId] = [""];
  }

  players[currentMode][selectedBuildingId].forEach((name, index) => {
    const item = document.createElement('div');
    item.className = 'modal-operator-item';

    const select = createPlayerSelect(`${t.operator} ${index + 1}`, name);
    select.className = 'modal-operator-input';
    select.style.cursor = 'pointer';
    select.dataset.index = index;
    select.addEventListener('change', (e) => {
      players[currentMode][selectedBuildingId][index] = e.target.value;
      saveToLocalStorage();
    });

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.innerHTML = '√ó';
    btnRemove.addEventListener('click', () => {
      players[currentMode][selectedBuildingId].splice(index, 1);
      renderModalOperatorsList();
      saveToLocalStorage();
    });

    item.appendChild(select);
    if (players[currentMode][selectedBuildingId].length > 1) {
      item.appendChild(btnRemove);
    }

    container.appendChild(item);
  });
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  selectedBuildingId = null;
}

function saveModal() {
  if (!selectedBuildingId) return;

  const inputs = document.querySelectorAll('#modalOperatorsList .modal-operator-input');
  players[currentMode][selectedBuildingId] = Array.from(inputs).map(input => input.value || "");

  saveToLocalStorage();
  renderEditView();
  closeModal();
}

// ===== SCREENSHOT VIEW =====
function renderScreenshotView() {
  const t = translations[currentLang];
  const buildings = modeConfigs[currentMode].buildings;

  document.getElementById('screenshotAllianceName').textContent = `${allianceConfig.alliance_logo} ${allianceConfig.alliance_name}`;
  document.getElementById('screenshotModeName').textContent = currentMode === 'canyon' ? t.canyonMode : t.desertMode;
  
  const dateStr = new Date().toLocaleDateString(currentLang, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  document.getElementById('screenshotDate').textContent = dateStr;

  const killSection = document.getElementById('screenshotKillSection');
  const killTags = document.getElementById('killTags');
  const ks = (players[currentMode].killSwat || []).filter(p => p && p.trim() !== "");

  killTags.innerHTML = "";
  if (ks.length > 0) {
    killSection.style.display = "block";
    document.getElementById('screenshotKillTitle').textContent = "‚ö° KILL SWAT";
    ks.forEach(p => {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = p;
      killTags.appendChild(tag);
    });
  } else {
    killSection.style.display = "none";
  }

  const reservesSection = document.getElementById('screenshotReservesSection');
  const reservesTags = document.getElementById('reservesTags');
  const reserves = (players[currentMode].reserves || []).filter(p => p && p.trim() !== "");

  reservesTags.innerHTML = "";
  if (reserves.length > 0) {
    reservesSection.style.display = "block";
    document.getElementById('screenshotReservesTitle').textContent = "üü® " + t.reserves.split(' - ')[0];
    reserves.forEach(p => {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = p;
      reservesTags.appendChild(tag);
    });
  } else {
    reservesSection.style.display = "none";
  }

  const mapContainer = document.getElementById('mapContainer');
  mapContainer.style.background = modeConfigs[currentMode].mapColor;
  mapContainer.innerHTML = "";

  buildings.forEach(b => {
    const wrapper = document.createElement('div');
    wrapper.className = 'map-building';
    wrapper.style.left = b.x + '%';
    wrapper.style.top = b.y + '%';

    const tile = document.createElement('div');
    tile.className = 'map-building-tile';
    tile.style.backgroundColor = b.color;

    if (b.protected) {
      const protectedBadge = document.createElement('div');
      protectedBadge.className = 'map-protected-badge';
      protectedBadge.textContent = 'üõ°Ô∏è';
      tile.appendChild(protectedBadge);
    }

    const idBadge = document.createElement('div');
    idBadge.className = 'map-id-badge';
    idBadge.textContent = b.id;
    tile.appendChild(idBadge);

    const icon = document.createElement('div');
    icon.textContent = b.icon;
    tile.appendChild(icon);

    wrapper.appendChild(tile);

    const assigned = (players[currentMode][b.id] || []).filter(p => p && p.trim() !== "");
    if (assigned.length > 0) {
      const operatorsDiv = document.createElement('div');
      operatorsDiv.className = 'map-operators';

      // Special case: Canyon building #4 (central) -> put names ABOVE the tile
      if (currentMode === 'canyon' && b.id === 4) {
        operatorsDiv.classList.add('center-column-top');
      } else if (currentMode === 'canyon' && (b.id === 9 || b.id === 12)) {
        operatorsDiv.classList.add('center-column');
      } else if (b.x < 30) {
        operatorsDiv.classList.add('left-column');
      } else if (b.x > 70) {
        operatorsDiv.classList.add('right-column');
      } else {
        operatorsDiv.classList.add('center-column');
      }

      assigned.forEach(p => {
        const nameDiv = document.createElement('div');
        nameDiv.className = 'map-operator-name';
        nameDiv.textContent = p;
        operatorsDiv.appendChild(nameDiv);
      });

      wrapper.appendChild(operatorsDiv);
    }

    mapContainer.appendChild(wrapper);
  });

  document.getElementById('strategyText').textContent = generateStrategyText();
}

// ===== GENERATE STRATEGY TEXT =====
function generateStrategyText() {
  if (currentMode === 'desert') {
    return generateDesertStormText();
  } else {
    return generateCanyonText();
  }
}

// ===== DESERT STORM DETAILED TEMPLATE =====
function generateDesertStormText() {
  const buildings = modeConfigs[currentMode].buildings;
  
  const killSwatList = (players[currentMode].killSwat || [])
    .filter(p => p && p.trim() !== "")
    .map(p => p.trim());
  
  const getPlayers = (buildingId) => {
    return (players[currentMode][buildingId] || [])
      .filter(p => p && p.trim() !== "")
      .map(p => p.trim());
  };
  
  const formatPlayerList = (playerArray) => {
    if (playerArray.length === 0) return '(assign players)';
    return playerArray.join(', ');
  };
  
  let text = `DESERT STORM ‚Äì h.18 Server\n`;
  text += `Kill SWAT order defined based on power ranking.\n\n`;
  
  text += `KILL SWAT: Their task is to intercept and neutralize priority enemy buildings, they move where needed.\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(killSwatList)}\n`;
  text += `‚∏ª\n\n`;
  
  text += `SEE IMAGE ON ALLIANCE ADS ‚Äì HOLD POSITION:\n`;
  text += `HOSPITAL 1: HOLD POSITION\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(1))}\n\n`;
  
  text += `HOSPITAL 2 and 4: HOLD POSITION, check if we start from the right or from the left, assess the situation, you can split up\n`;
  text += `‚ù§Ô∏è ${formatPlayerList([...getPlayers(2), ...getPlayers(4)])}\n\n`;
  
  text += `HOSPITAL 3: HOLD POSITION\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(3))}\n`;
  text += `‚∏ª\n\n`;
  
  text += `REFINERY 5 and 8: Evaluate the situation and see if it's worth splitting up, plan A and plan B\n`;
  text += `‚ù§Ô∏è ${formatPlayerList([...getPlayers(5), ...getPlayers(8)])}\n`;
  text += `‚∏ª\n\n`;
  
  text += `TECHNOLOGY CENTER 7: Very important building that allows you to halve the teleportation recharge time, it's a bloodbath\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(7))} and KILL SWAT\n`;
  text += `‚∏ª\n\n`;
  
  text += `INFORMATION CENTER 6: Increases efficiency points of all captured buildings, HOLD POSITION\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(6))} and KILL SWAT\n`;
  text += `‚∏ª\n\n`;
  
  text += `MERCENARY FACTORY 9: Decreases enemy attack power, defense and health points by -15%.\n`;
  text += `While waiting for the unlock, help comrades at REFINERY\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(9))} and KILL SWAT\n`;
  text += `‚∏ª\n\n`;
  
  text += `ARSENAL 10: Increases allies' attack power, defense and health points by +15%.\n`;
  text += `While waiting for the unlock, help comrades at INFORMATION CENTER\n`;
  text += `‚ù§Ô∏è ${formatPlayerList(getPlayers(10))} and KILL SWAT\n`;
  text += `‚∏ª\n\n`;
  
  text += `NUCLEAR SILO 11: Whoever is assigned, before the release go and help in HOSPITALS where there is need\n`;
  text += `‚ù§Ô∏è KILL SWAT\n`;
  
  return text;
}

// ===== CANYON SIMPLE TEMPLATE (ORIGINAL) =====
function generateCanyonText() {
  const t = translations[currentLang];
  const buildings = modeConfigs[currentMode].buildings;

  const killSwatNames = (players[currentMode].killSwat || [])
    .filter(p => p && p.trim() !== "")
    .join(", ") || "**********";

  const reservesNames = (players[currentMode].reserves || [])
    .filter(p => p && p.trim() !== "")
    .join(", ") || "**********";

  const getNames = (ids) => {
    const all = [];
    ids.forEach(id => {
      const playersList = players[currentMode][id] || players[currentMode]['b' + id] || [];
      playersList.forEach(p => {
        if (p && p.trim() !== "") all.push(p.trim());
      });
    });
    return all.join(", ") || "**********";
  };

  const dateStr = new Date().toLocaleDateString(currentLang, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  const modeName = currentMode === 'canyon' ? t.canyon : t.desert;

  let text = `${allianceConfig.alliance_name.toUpperCase()} - ${modeName.toUpperCase()} STRATEGY\n\n`;
  text += `Date: ${dateStr}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  
  text += `‚ö° KILL SWAT\n\n`;
  text += `Operators: ${killSwatNames}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

  buildings.forEach(b => {
    text += `${b.icon} ${b.type[currentLang].toUpperCase()} - BUILDING ${b.id}\n`;
    text += `Rate: +${b.rate}/s${b.protected ? ' (Protected)' : ''}\n`;
    text += `Operators: ${getNames([b.id])}\n\n`;
  });

  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  text += `üü® RESERVES\n\n`;
  text += `Operators: ${reservesNames}\n\n`;
  text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  text += `üí™ ${allianceConfig.alliance_name.toUpperCase()}! üí™`;

  return text;
}

// ===== COPY TO CLIPBOARD =====
function copyStrategy(btnId) {
  const text = generateStrategyText();
  const t = translations[currentLang];

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showCopyFeedback(btnId, t.copied);
    }).catch(() => {
      fallbackCopy(text);
      showCopyFeedback(btnId, t.copied);
    });
  } else {
    fallbackCopy(text);
    showCopyFeedback(btnId, t.copied);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
  } catch (e) {}
  document.body.removeChild(textarea);
}

function showCopyFeedback(btnId, text) {
  const btn = document.getElementById(btnId);
  const originalHTML = btn.innerHTML;
  btn.innerHTML = `‚úÖ ${text}`;
  btn.style.background = '#16a34a';

  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.style.background = '';
  }, 2000);
}

// ===== NAVIGATION =====
function showScreenshotView() {
  renderScreenshotView();
  document.getElementById('editView').classList.add('hidden');
  document.querySelector('.header').classList.add('hidden');
  document.getElementById('screenshotView').classList.remove('hidden');
  window.scrollTo(0, 0);
}

function showEditView() {
  document.getElementById('screenshotView').classList.add('hidden');
  document.querySelector('.header').classList.remove('hidden');
  document.getElementById('editView').classList.remove('hidden');
}

// ===== ATTENDANCE SYSTEM =====

// Load last formation from Google Sheets
async function loadLastFormation() {
  const btnLoad = document.getElementById('btnLoadFormation');
  const originalHTML = btnLoad.innerHTML;
  
  try {
    btnLoad.disabled = true;
    btnLoad.innerHTML = '‚è≥ <span>Loading...</span>';
    
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLastFormation&mode=${currentMode}&team=${attendanceTeam}`);
    const result = await response.json();
    
    if (result.status === 'success') {
      lastFormationData = result.data.players || [];
      attendanceData = {}; // Reset attendance
      
      renderAttendanceTable();
      
      // Enable save button
      document.getElementById('btnSaveAttendance').disabled = false;
      
      console.log('‚úÖ Loaded', lastFormationData.length, 'players from last formation');
    } else {
      alert('‚ùå Error loading formation: ' + result.message);
    }
  } catch (error) {
    console.error('Error loading formation:', error);
    alert('‚ùå Error loading formation. Check console.');
  } finally {
    btnLoad.disabled = false;
    btnLoad.innerHTML = originalHTML;
  }
}

// Render attendance table
function renderAttendanceTable() {
  const tbody = document.getElementById('attendanceTableBody');
  const emptyState = document.getElementById('attendanceEmptyState');
  
  if (lastFormationData.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  tbody.innerHTML = '';
  
  lastFormationData.forEach(player => {
    const row = document.createElement('tr');
    
    // Player Name
    const nameCell = document.createElement('td');
    nameCell.className = 'player-name-cell';
    nameCell.textContent = player.name;
    row.appendChild(nameCell);
    
    // Building
    const buildingCell = document.createElement('td');
    buildingCell.className = 'building-name-cell';
    buildingCell.textContent = player.building || '‚Äî';
    row.appendChild(buildingCell);
    
    // Attended Button
    const attendedCell = document.createElement('td');
    const btnYes = document.createElement('button');
    btnYes.className = 'btn-attendance-check yes';
    btnYes.innerHTML = '‚úÖ';
    btnYes.dataset.player = player.name;
    btnYes.dataset.status = 'YES';
    if (attendanceData[player.name] === 'YES') {
      btnYes.classList.add('active');
    }
    btnYes.addEventListener('click', () => handleAttendanceClick(player.name, 'YES'));
    attendedCell.appendChild(btnYes);
    row.appendChild(attendedCell);
    
    // Absent Button
    const absentCell = document.createElement('td');
    const btnNo = document.createElement('button');
    btnNo.className = 'btn-attendance-check no';
    btnNo.innerHTML = '‚õî';
    btnNo.dataset.player = player.name;
    btnNo.dataset.status = 'NO';
    if (attendanceData[player.name] === 'NO') {
      btnNo.classList.add('active');
    }
    btnNo.addEventListener('click', () => handleAttendanceClick(player.name, 'NO'));
    absentCell.appendChild(btnNo);
    row.appendChild(absentCell);
    
    tbody.appendChild(row);
  });
}

// Handle attendance checkbox click
function handleAttendanceClick(playerName, status) {
  // Toggle: if same button clicked again, uncheck it
  if (attendanceData[playerName] === status) {
    delete attendanceData[playerName];
  } else {
    attendanceData[playerName] = status;
  }
  
  renderAttendanceTable();
}

// Save attendance to Google Sheets
async function saveAttendance() {
  // Check R4 code first
  const r4Code = prompt('üîê Enter R4 code to save attendance:');
  if (!r4Code) {
    alert('‚ö†Ô∏è R4 code required');
    return;
  }
  
  const btnSave = document.getElementById('btnSaveAttendance');
  const originalHTML = btnSave.innerHTML;
  
  try {
    btnSave.disabled = true;
    btnSave.innerHTML = '‚è≥ <span>Saving...</span>';
    
    // Prepare attendance data
    const attendances = lastFormationData.map(player => ({
      player: player.name,
      building: player.building || '',
      attended: attendanceData[player.name] || 'UNKNOWN'
    }));
    
    const payload = {
      action: 'saveAttendance',
      r4Code: r4Code,
      mode: currentMode,
      team: attendanceTeam,
      attendances: attendances
    };
    
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      alert('‚úÖ Attendance saved successfully!');
      
      // Reset
      lastFormationData = [];
      attendanceData = {};
      renderAttendanceTable();
      btnSave.disabled = true;
    } else {
      alert('‚ùå Error: ' + result.message);
    }
  } catch (error) {
    console.error('Error saving attendance:', error);
    alert('‚ùå Error saving attendance. Check console.');
  } finally {
    btnSave.disabled = false;
    btnSave.innerHTML = originalHTML;
  }
}

// Setup attendance event listeners
function setupAttendanceListeners() {
  // Vintage switch
  const switchInput = document.getElementById('attendanceTeamSwitch');
  switchInput.addEventListener('change', (e) => {
    attendanceTeam = e.target.checked ? 'B' : 'A';
    console.log('üìã Attendance team:', attendanceTeam);
    
    // Reset table when switching teams
    lastFormationData = [];
    attendanceData = {};
    renderAttendanceTable();
    document.getElementById('btnSaveAttendance').disabled = true;
  });
  
  // Load button
  document.getElementById('btnLoadFormation').addEventListener('click', loadLastFormation);
  
  // Save button
  document.getElementById('btnSaveAttendance').addEventListener('click', saveAttendance);
}

// ===== START =====
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>